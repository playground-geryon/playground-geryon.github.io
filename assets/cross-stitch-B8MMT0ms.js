import{r as n,j as e,E as yn}from"./vendor-CRMzTT1s.js";import{l as zt,m as Wt,n as Dt,S as te,T as U,p as Ht,a as Z,o as ke,B as G,bw as ks,bx as Rs,Y as Ps,g as It,a7 as ce,aw as Pn,aJ as Es,at as Is,ab as Mt,au as jn,ac as Qt,bc as zs,be as Ws,a1 as Ds,by as Hs,bo as Os,ay as Fs,P as Ls,bj as Bs,C as As}from"./mui-BTFQHN8y.js";import"./excel-CUMakpxJ.js";import"./tree-sitter-aGyQ8e2w.js";const en=800,En=i=>new Promise((h,f)=>{const v=new FileReader;v.onload=()=>h(String(v.result)),v.onerror=C=>f(C),v.readAsDataURL(i)}),Ts=i=>new Promise((h,f)=>{const v=new Image;v.crossOrigin="anonymous",v.onload=()=>h(v),v.onerror=C=>f(C),v.src=i}),Zt=i=>i.toString(16).padStart(2,"0"),nn=(i,h,f)=>`#${Zt(i)}${Zt(h)}${Zt(f)}`,Xs=async i=>{const h=await fetch(i,{mode:"cors"});if(!h.ok)throw new Error("이미지를 불러오지 못했습니다.");const f=await h.blob();return En(new File([f],"remote-image"))},Jt=(i,h)=>{const v=255/(2**h-1),C=Math.round(i/v)*v;return Math.max(0,Math.min(255,Math.round(C)))},Us=(i,h)=>{if(h===0)return i;const f=parseInt(i.slice(1,3),16),v=parseInt(i.slice(3,5),16),C=parseInt(i.slice(5,7),16),b=h===8?{r:3,g:3,b:2}:h===16?{r:5,g:6,b:5}:{r:8,g:8,b:8},W=Jt(f,b.r),P=Jt(v,b.g),x=Jt(C,b.b);return nn(W,P,x)},bt=i=>{const h=i.trim().replace(/^#/,"");return/^[0-9a-fA-F]{6}$/.test(h)?`#${h.toLowerCase()}`:null},Sn=(i,h)=>{const f=bt(i);if(!f)return null;if(h[f])return f;const v=Object.entries(h).find(([,C])=>C===f);return v?v[0]:f},Ys=(i,h)=>h[i]??i,tn=i=>({r:parseInt(i.slice(1,3),16),g:parseInt(i.slice(3,5),16),b:parseInt(i.slice(5,7),16)}),$s=32,kn=(i,h)=>(i.r-h.r)**2+(i.g-h.g)**2+(i.b-h.b)**2,Gs=(i,h=$s)=>{const f=i.map(b=>({...tn(b.hex),count:b.count}));if(!f.length)return[];let v=[{items:f}];const C=b=>{if(b.items.length<=1)return[b];const W=["r","g","b"].map(S=>{const F=b.items.map(N=>N[S]);return Math.max(...F)-Math.min(...F)}),P=W.indexOf(Math.max(...W)),x=["r","g","b"][P],m=[...b.items].sort((S,F)=>S[x]-F[x]),A=m.reduce((S,F)=>S+F.count,0);let z=0,d=0;for(;d<m.length&&(z+=m[d].count,!(z>=A/2));d++);if(d<=0||d>=m.length-1){const S=Math.floor(m.length/2);return[{items:m.slice(0,S)},{items:m.slice(S)}]}return[{items:m.slice(0,d+1)},{items:m.slice(d+1)}]};for(;v.length<h;){v.sort((x,m)=>m.items.length-x.items.length);const b=v.shift();if(!b)break;if(b.items.length<=1){v.push(b);break}const[W,P]=C(b);if(v.push(W),v.push(P),v.length>=h)break}return v.map(b=>{const W=b.items.reduce((A,z)=>A+z.count,0);if(!W)return null;const P=Math.round(b.items.reduce((A,z)=>A+z.r*z.count,0)/W),x=Math.round(b.items.reduce((A,z)=>A+z.g*z.count,0)/W),m=Math.round(b.items.reduce((A,z)=>A+z.b*z.count,0)/W);return{hex:nn(P,x,m),count:W,percent:0}}).filter(b=>!!b).sort((b,W)=>W.count-b.count)},Ns=async(i,h,f,v,C,b,W,P,x)=>{const m=await Ts(i),A=C?1:Math.min(en/Math.max(m.width,m.height),1),z=Math.max(1,Math.round(m.width*A)),d=Math.max(1,Math.round(m.height*A)),S=Math.max(1,Math.min(Math.round(h),z)),F=Math.max(1,Math.round(d/z*S)),N=document.createElement("canvas");N.width=z,N.height=d;const oe=N.getContext("2d",{willReadFrequently:!0});if(!oe)throw new Error("캔버스를 초기화할 수 없습니다.");oe.drawImage(m,0,0,z,d);const ue=Math.max(1,Math.floor(en/Math.max(S,F))),K=S*ue,fe=F*ue,V=document.createElement("canvas");V.width=K,V.height=fe;const J=V.getContext("2d");if(!J)throw new Error("캔버스를 초기화할 수 없습니다.");const re=J.createImageData(K,fe),L=new Map,B=[],we="#ffffff",k=z/S,ae=d/F,ne=K/S,ve=fe/F;x(10),B.length=0,L.clear();const Me=F*S;for(let a=0;a<F;a++){for(let u=0;u<S;u++){const M=Math.floor(u*k),g=Math.floor(a*ae),y=Math.min(z,Math.floor((u+1)*k)),X=Math.min(d,Math.floor((a+1)*ae)),$=Math.max(1,y-M),p=Math.max(1,X-g),R=oe.getImageData(M,g,$,p).data,E=new Map;for(let I=0;I<R.length;I+=4){if(R[I+3]===0)continue;const ee=R[I]<<16|R[I+1]<<8|R[I+2];E.set(ee,(E.get(ee)??0)+1)}let Y=-1,H=0;E.forEach((I,Q)=>{I>H&&(H=I,Y=Q)});const be=H>0?nn(Y>>16&255,Y>>8&255,Y&255):we,Ye=Us(be,f),He=Math.round(u*ne),ze=Math.round(a*ve),Ct=Math.round((u+1)*ne),Ke=Math.round((a+1)*ve),st=Math.max(1,Ct-He),D=Math.max(1,Ke-ze);B.push({key:`${u},${a}`,x0:He,y0:ze,cellPixW:st,cellPixH:D,hex:Ye}),L.set(Ye,(L.get(Ye)??0)+st*D)}const s=(a+1)*S/Me;x(Math.min(90,10+s*80))}J.putImageData(re,0,0);const se=K*fe;let T=Array.from(L.entries()).map(([a,s])=>({hex:a,count:s,percent:0})),he=[];P>0&&T.length>P&&(T=Gs(T,P),he=T.map(a=>({hex:a.hex,rgb:tn(a.hex)})));const ie=a=>{if(!he.length)return a;const s=tn(a);let u=he[0],M=kn(s,u.rgb);for(const g of he.slice(1)){const y=kn(s,g.rgb);y<M&&(M=y,u=g)}return u.hex};L.clear(),B.forEach(({key:a,x0:s,y0:u,cellPixW:M,cellPixH:g,hex:y})=>{const X=he.length?ie(y):y,$=W[a],p=$||Ys(X,b);L.set(p,(L.get(p)??0)+M*g);for(let R=0;R<g;R++)for(let E=0;E<M;E++){const Y=((u+R)*K+(s+E))*4;re.data[Y]=parseInt(p.slice(1,3),16),re.data[Y+1]=parseInt(p.slice(3,5),16),re.data[Y+2]=parseInt(p.slice(5,7),16),re.data[Y+3]=255}}),J.putImageData(re,0,0),T=Array.from(L.entries()).map(([a,s])=>({hex:a,count:s,percent:Number((s/se*100).toFixed(2))})).sort((a,s)=>s.count-a.count);const xe=V.toDataURL("image/png");return v(null),x(100),{pixelatedSrc:xe,colors:T,totalPixels:se,uniqueCount:T.length,originalSize:{width:m.width,height:m.height},renderedSize:{width:K,height:fe},colCount:S,rowCount:F}},qs=()=>{const[i,h]=n.useState(null),[f,v]=n.useState(null),[C,b]=n.useState(null),[W,P]=n.useState([]),[x,m]=n.useState(0),[A,z]=n.useState(0),[d,S]=n.useState(!1),[F,N]=n.useState(null),[oe,ue]=n.useState({width:0,height:0}),[K,fe]=n.useState({width:0,height:0}),[V,J]=n.useState(0),[re,L]=n.useState(0),[B,we]=n.useState(112),[k,ae]=n.useState(32),[ne,ve]=n.useState(!1),[Me,se]=n.useState(0),[T,he]=n.useState({}),[ie,xe]=n.useState({}),a=n.useRef([]),[s,u]=n.useState(!1),[M,g]=n.useState("count"),[y,X]=n.useState(0),$=n.useRef(null),p=n.useRef(0),R=n.useRef(B);n.useEffect(()=>{if(typeof Worker>"u")return;const D=new Worker(new URL("/assets/cross-stitch-worker-DMERlEjB.js",import.meta.url),{type:"module"});return $.current=D,()=>{D.terminate(),$.current=null}},[]);const E=n.useCallback(async(D,I,Q,ee,de,Re,ge)=>{S(!0),N(null),se(0);try{const me=$.current,Pe=p.current+1;p.current=Pe;const $e=()=>new Promise((Ot,ot)=>{if(!me)return ot(new Error("worker unavailable"));const Oe=Ge=>{const{id:Ft,type:Ne,value:rt,payload:pe,message:Lt}=Ge.data||{};if(Ft===Pe){if(Ne==="progress"){se(rt);return}if(Ne==="result"){me.removeEventListener("message",Oe),Ot(pe);return}Ne==="error"&&(me.removeEventListener("message",Oe),ot(new Error(Lt||"이미지 처리 중 오류가 발생했습니다.")))}};me.addEventListener("message",Oe),me.postMessage({id:Pe,payload:{dataUrl:D,colCountInput:I,bitDepth:Q,useOriginalSize:ee,overrides:de,cellOverrides:Re,paletteSize:ge}})});let Ce;try{Ce=await $e()}catch{Ce=await Ns(D,I,Q,N,ee,de,Re,ge,se)}b(Ce.pixelatedSrc),P(Ce.colors),m(Ce.uniqueCount),z(Ce.totalPixels),ue(Ce.originalSize),fe(Ce.renderedSize),J(Ce.colCount),L(Ce.rowCount)}catch(me){N(me?.message??"이미지 처리 중 오류가 발생했습니다."),P([]),m(0),z(0),b(null)}finally{S(!1),se(100)}},[]),Y=D=>{N(null),h(D),v(D),b(null),P([]),m(0),z(0),he({}),xe({}),a.current=[],u(!1)},H=async D=>{try{const I=await En(D);Y(I)}catch(I){N(I?.message??"이미지를 불러오는 중 문제가 발생했습니다.")}},be=async D=>{try{const I=await Xs(D);Y(I)}catch(I){N(I?.message??"이미지 URL을 불러오는 중 문제가 발생했습니다.")}};n.useEffect(()=>{f&&(R.current!==B&&(R.current=B,xe({}),a.current=[],u(!1)),E(f,B,k,ne,T,ie,y))},[B,ie,k,T,M,y,ne,f,E]);const De=()=>{const D=ne?oe.width:K.width;return Math.max(1,Math.round(D||en))};return{imageSrc:i,pixelatedSrc:C,colors:W,uniqueCount:x,totalPixels:A,loading:d,error:F,originalSize:oe,renderedSize:K,blockSize:B,setBlockSize:D=>{const I=Math.min(De(),Math.max(1,Math.round(D)));we(I)},colorBit:k,setColorBit:ae,useOriginalSize:ne,setUseOriginalSize:ve,colorOverrides:T,cellOverrides:ie,applyColorOverride:async(D,I)=>{const Q=Sn(D,T),ee=bt(I);if(!Q||!ee){N("HEX 색상 코드를 #RRGGBB 형태로 입력하세요.");return}const de={...T,[Q]:ee};he(de),f&&await E(f,B,k,ne,de,ie,y)},applyCellOverride:async(D,I,Q)=>{const ee=bt(Q);if(!ee){N("HEX 색상 코드를 #RRGGBB 형태로 입력하세요.");return}const de=`${D},${I}`,Re={...ie,[de]:ee};a.current.push([{key:de,prev:ie[de]}]),u(!0),xe(Re),f&&await E(f,B,k,ne,T,Re,y)},applyCellOverridesBatch:async D=>{if(D.length===0)return;const I={...ie},Q=[];D.forEach(({col:ee,row:de,color:Re})=>{const ge=bt(Re);if(!ge)return;const me=`${ee},${de}`;I[me]!==ge&&(Q.push({key:me,prev:I[me]}),I[me]=ge)}),Q.length!==0&&(a.current.push(Q),u(!0),xe(I),f&&await E(f,B,k,ne,T,I,y))},undoCellEdit:async()=>{const D=a.current,I=D.pop();if(!I)return;const Q={...ie};I.forEach(({key:ee,prev:de})=>{de?Q[ee]=de:delete Q[ee]}),xe(Q),u(D.length>0),f&&await E(f,B,k,ne,T,Q,y)},canUndoCellEdit:s,applyColorOverridesBatch:async(D,I)=>{const Q=bt(I);if(!Q){N("HEX 색상 코드를 #RRGGBB 형태로 입력하세요.");return}const ee={...T};let de=!1;for(const Re of D){const ge=Sn(Re,ee);ge&&(ee[ge]=Q,de=!0)}de&&(he(ee),f&&await E(f,B,k,ne,ee,ie,y))},extractionMode:M,setExtractionMode:g,paletteSize:y,setPaletteSize:X,handleDataUrl:Y,handleFile:H,handleUrl:be,originalDataUrl:f,renderedCols:V,renderedRows:re,progress:Me}},_s=({open:i,onClose:h,onSelect:f})=>e.jsxs(zt,{open:i,onClose:h,maxWidth:"xs",fullWidth:!0,children:[e.jsx(Wt,{children:"편집 대상 선택"}),e.jsx(Dt,{children:e.jsx(te,{spacing:1,children:e.jsx(U,{variant:"body2",color:"text.secondary",children:"원본 이미지 또는 현재 미리보기를 선택해 편집할 수 있습니다."})})}),e.jsxs(Ht,{children:[e.jsx(Z,{onClick:h,children:"취소"}),e.jsx(Z,{variant:"outlined",onClick:()=>f("original"),children:"원본"}),e.jsx(Z,{variant:"contained",onClick:()=>f("preview"),children:"미리보기"})]})]}),Ks=({open:i,linkValue:h,onClose:f,onChange:v,onSubmit:C})=>e.jsxs(zt,{open:i,onClose:f,maxWidth:"sm",fullWidth:!0,children:[e.jsx(Wt,{children:"이미지 링크로 불러오기"}),e.jsx(Dt,{children:e.jsx(ke,{autoFocus:!0,fullWidth:!0,label:"이미지 URL",placeholder:"https://example.com/image.png",value:h,onChange:b=>v(b.target.value),variant:"outlined",size:"small",margin:"dense"})}),e.jsxs(Ht,{children:[e.jsx(Z,{onClick:f,children:"취소"}),e.jsx(Z,{onClick:C,variant:"contained",disabled:!h.trim(),autoFocus:!0,children:"불러오기"})]})]}),Ie=(i,h,f)=>Math.min(Math.max(i,h),f),Vs=({open:i,dataUrl:h,onApply:f,onSkip:v,onCancel:C})=>{const b=n.useRef(null),W=n.useRef(null),P=n.useRef(null),x=n.useRef(null),m=n.useRef({mode:"none",offsetX:0,offsetY:0}),[A,z]=n.useState(0),[d,S]=n.useState(null),[F,N]=n.useState({w:0,h:0,scale:1}),[oe,ue]=n.useState(!1),[K,fe]=n.useState({w:0,h:0}),[V,J]=n.useState(null),re=(a,s)=>{const u=Math.max(4,6/F.scale),M=Math.max(3,4/F.scale),g=Math.abs(a.x-s.x),y=Math.abs(a.x-(s.x+s.w)),X=Math.abs(a.y-s.y),$=Math.abs(a.y-(s.y+s.h)),p=g<=M,R=y<=M,E=X<=M,Y=$<=M;let H="none";p&&E?H="nw":R&&E?H="ne":p&&Y?H="sw":R&&Y&&(H="se");let be=!1,De=!1,Ye=!1,He=!1;if(H!=="none")return be=H==="nw"||H==="sw",De=H==="ne"||H==="se",Ye=H==="nw"||H==="ne",He=H==="sw"||H==="se",{left:be,right:De,top:Ye,bottom:He,corner:H};const ze=Math.min(g,y,X,$);return ze>u?{left:!1,right:!1,top:!1,bottom:!1,corner:"none"}:ze===g?{left:!0,right:!1,top:!1,bottom:!1,corner:"none"}:ze===y?{left:!1,right:!0,top:!1,bottom:!1,corner:"none"}:ze===X?{left:!1,right:!1,top:!0,bottom:!1,corner:"none"}:{left:!1,right:!1,top:!1,bottom:!0,corner:"none"}},L=n.useMemo(()=>!K.w||!K.h?{w:0,h:0}:A%180===0?{w:K.w,h:K.h}:{w:K.h,h:K.w},[A,K]),B=n.useCallback(()=>{const a=P.current;if(!a)return;const{w:s,h:u}=L,M=document.createElement("canvas");M.width=s,M.height=u;const g=M.getContext("2d");g&&(g.save(),A===90?(g.translate(s,0),g.rotate(Math.PI/2)):A===180?(g.translate(s,u),g.rotate(Math.PI)):A===270&&(g.translate(0,u),g.rotate(3*Math.PI/2)),g.drawImage(a,0,0),g.restore(),x.current=M)},[A,L]),we=n.useCallback(()=>{const a=b.current,s=W.current,u=x.current;if(!a||!s||!u)return;const M=Math.max(240,Math.min(640,s.clientWidth||640)),y=Math.min(M/u.width,360/u.height,1),X=Math.round(u.width*y),$=Math.round(u.height*y);a.width=X,a.height=$,a.style.width=`${X}px`,a.style.height=`${$}px`;const p=a.getContext("2d");if(p){if(p.clearRect(0,0,X,$),p.imageSmoothingEnabled=!1,p.drawImage(u,0,0,X,$),d){const R=d.x*y,E=d.y*y,Y=d.w*y,H=d.h*y,be=m.current.mode==="resize"?m.current.edges:V,De="#1976d2";p.save(),p.strokeStyle="#2e7d32",p.lineWidth=2,p.strokeRect(R+.5,E+.5,Y-1,H-1),be&&(p.strokeStyle=De,p.lineWidth=3,be.top&&(p.beginPath(),p.moveTo(R,E),p.lineTo(R+Y,E),p.stroke()),be.bottom&&(p.beginPath(),p.moveTo(R,E+H),p.lineTo(R+Y,E+H),p.stroke()),be.left&&(p.beginPath(),p.moveTo(R,E),p.lineTo(R,E+H),p.stroke()),be.right&&(p.beginPath(),p.moveTo(R+Y,E),p.lineTo(R+Y,E+H),p.stroke())),p.fillStyle="rgba(0,0,0,0.2)",p.fillRect(0,0,X,E),p.fillRect(0,E+H,X,$-E-H),p.fillRect(0,E,R,H),p.fillRect(R+Y,E,X-R-Y,H),p.restore()}N({w:X,h:$,scale:y})}},[d]);n.useEffect(()=>{if(!h||!i)return;const a=new Image;a.onload=()=>{P.current=a,fe({w:a.width,h:a.height}),z(0),S({x:0,y:0,w:a.width,h:a.height})},a.src=h},[h,i]),n.useEffect(()=>{if(!P.current)return;B();const{w:a,h:s}=L;S(u=>u?{x:0,y:0,w:a,h:s}:{x:0,y:0,w:a,h:s})},[B,L]),n.useEffect(()=>{we()},[we,d,A,i]);const k=(a,s)=>{const u=b.current;if(!u)return null;const M=u.getBoundingClientRect(),g=(a-M.left)/F.scale,y=(s-M.top)/F.scale;return{x:g,y}},ae=a=>{if(!x.current)return;const s=k(a.clientX,a.clientY);if(s){if(ue(!0),d){const u=Math.round(d.x)===0&&Math.round(d.y)===0&&Math.round(d.w)===Math.round(x.current.width)&&Math.round(d.h)===Math.round(x.current.height),M=re(s,d),g=(M.left||M.right||M.top||M.bottom)&&!u,y=s.x>=d.x&&s.x<=d.x+d.w&&s.y>=d.y&&s.y<=d.y+d.h;if(g){m.current={mode:"resize",offsetX:s.x,offsetY:s.y,edges:M,startRect:{...d}};return}if(y&&!u){m.current={mode:"drag",offsetX:s.x-d.x,offsetY:s.y-d.y};return}}m.current={mode:"new",offsetX:s.x,offsetY:s.y},S({x:s.x,y:s.y,w:1,h:1})}},ne=a=>{if(!x.current)return;const s=x.current,u={x:Ie(a.x,0,s.width),y:Ie(a.y,0,s.height)};if(m.current.mode==="drag"&&d){const M=Ie(u.x-m.current.offsetX,0,s.width-d.w),g=Ie(u.y-m.current.offsetY,0,s.height-d.h);S({...d,x:M,y:g});return}if(m.current.mode==="resize"&&d){const M=m.current.edges,g=m.current.startRect??d;if(!M)return;let y=g.x,X=g.y,$=g.w,p=g.h;if(M.left){const R=g.x+g.w-1;y=Ie(u.x,0,R),$=R-y}if(M.right){const R=g.x+1;$=Ie(u.x,R,s.width)-g.x}if(M.top){const R=g.y+g.h-1;X=Ie(u.y,0,R),p=R-X}if(M.bottom){const R=g.y+1;p=Ie(u.y,R,s.height)-g.y}S({x:y,y:X,w:Math.max(1,$),h:Math.max(1,p)});return}if(m.current.mode==="new"){const M=m.current.offsetX,g=m.current.offsetY,y=Ie(M,0,s.width),X=Ie(g,0,s.height),$=Ie(u.x,0,s.width),p=Ie(u.y,0,s.height),R=Math.min(y,$),E=Math.min(X,p),Y=Math.max(1,Math.abs($-y)),H=Math.max(1,Math.abs(p-X));S({x:R,y:E,w:Y,h:H});return}},ve=a=>{if(!x.current)return;const s=k(a.clientX,a.clientY);if(!s)return;if(m.current.mode!=="none"){ne(s);return}const u=x.current;if(m.current.mode==="none"&&d){if(Math.round(d.x)===0&&Math.round(d.y)===0&&Math.round(d.w)===Math.round(u.width)&&Math.round(d.h)===Math.round(u.height)){J(null);return}const g=re(s,d);g.left||g.right||g.top||g.bottom?J(g):J(null)}},Me=()=>{m.current={mode:"none",offsetX:0,offsetY:0},ue(!1)},se=n.useCallback(a=>{if(!oe)return;const s=k(a.clientX,a.clientY);s&&ne(s)},[oe]),T=n.useCallback(()=>{oe&&(m.current={mode:"none",offsetX:0,offsetY:0},ue(!1))},[oe]);n.useEffect(()=>{if(oe)return window.addEventListener("mousemove",se),window.addEventListener("mouseup",T),()=>{window.removeEventListener("mousemove",se),window.removeEventListener("mouseup",T)}},[oe,se,T]);const he=a=>{z(s=>(s+(a==="left"?-90:90)+360)%360)},ie=()=>{const a=P.current;a&&(z(0),S({x:0,y:0,w:a.width,h:a.height}))},xe=()=>{const a=x.current;if(!a||!d)return;const s=document.createElement("canvas");s.width=Math.round(d.w),s.height=Math.round(d.h);const u=s.getContext("2d");u&&(u.drawImage(a,Math.round(d.x),Math.round(d.y),Math.round(d.w),Math.round(d.h),0,0,Math.round(d.w),Math.round(d.h)),f(s.toDataURL("image/png")))};return e.jsxs(zt,{open:i,onClose:C,maxWidth:"md",fullWidth:!0,children:[e.jsx(Wt,{children:"이미지 자르기/회전"}),e.jsx(Dt,{children:e.jsxs(te,{spacing:1.5,children:[e.jsx(U,{variant:"body2",color:"text.secondary",children:"이미지 영역을 드래그해 선택한 뒤 적용하세요."}),e.jsx(G,{ref:W,sx:{border:"1px solid",borderColor:"divider",borderRadius:1,p:1,display:"flex",alignItems:"center",justifyContent:"center",bgcolor:"background.default",minHeight:360},children:e.jsx("canvas",{ref:b,onMouseDown:ae,onMouseMove:ve,onMouseUp:Me,onMouseLeave:()=>J(null),style:{cursor:V?V.corner==="nw"||V.corner==="se"?"nwse-resize":V.corner==="ne"||V.corner==="sw"?"nesw-resize":V.top||V.bottom?"n-resize":V.left||V.right?"e-resize":"crosshair":m.current.mode==="drag"?"move":"crosshair"}})}),e.jsxs(te,{direction:"row",spacing:1,alignItems:"center",flexWrap:"wrap",children:[e.jsx(Z,{variant:"outlined",size:"small",startIcon:e.jsx(ks,{}),onClick:()=>he("left"),children:"왼쪽 회전"}),e.jsx(Z,{variant:"outlined",size:"small",startIcon:e.jsx(Rs,{}),onClick:()=>he("right"),children:"오른쪽 회전"}),e.jsx(Z,{variant:"text",size:"small",onClick:ie,children:"전체 선택"}),e.jsxs(U,{variant:"caption",color:"text.secondary",children:["현재 크기: ",L.w," × ",L.h,"px"]})]})]})}),e.jsxs(Ht,{children:[e.jsx(Z,{onClick:C,children:"취소"}),e.jsx(Z,{onClick:v,variant:"outlined",children:"원본 사용"}),e.jsx(Z,{onClick:xe,variant:"contained",children:"적용"})]})]})},sn={border:"1px solid",borderColor:"divider",borderRadius:1.5,bgcolor:"background.paper",display:"flex",flexDirection:"column",overflow:"hidden",maxWidth:"100%"},In=i=>/^#?[0-9a-fA-F]{6}$/.test(i.trim()),Zs=i=>{const h=i.trim().replace(/^#/,"").toLowerCase();return/^[0-9a-f]{6}$/.test(h)?`#${h}`:null},Rn=(i,h)=>{const f=parseFloat(i);return Number.isNaN(f)||f<=0?h:f},Js=({palette:i,uniqueCount:h,paletteSort:f,onSortChange:v,multiSelectMode:C,multiSelection:b,selectedPalette:W,onToggleSelectMode:P,onToggleSelection:x,onSelectPalette:m,selectedSwatchRef:A,overrideHex:z,onOverrideHexChange:d,overrideIsValid:S,overrideColorValue:F,onApplyOverride:N,palettePage:oe,palettePageCount:ue,onPalettePageChange:K,cellEditMode:fe,onToggleCellEditMode:V,cellEditColor:J,onCellEditColorChange:re,cellEditTool:L,onCellEditToolChange:B})=>{const we=!C&&!W||C&&b.length===0;return e.jsxs(G,{sx:{...sn,width:400,minHeight:0,flexShrink:0},children:[e.jsx(G,{sx:{display:"flex",flexDirection:"column"},children:e.jsx(G,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",px:1.25,py:1.25,borderBottom:"1px solid",borderColor:"divider"},children:e.jsxs(te,{direction:"row",alignItems:"center",justifyContent:"space-between",spacing:1,sx:{flex:1},children:[e.jsx(U,{variant:"subtitle1",fontWeight:700,children:"색상 · 팔레트"}),e.jsx(Ps,{size:"small",label:`${h.toLocaleString()} colors`,variant:"outlined"})]})})}),e.jsxs(G,{sx:{p:1.25,display:"flex",flexDirection:"column",gap:1.25},children:[e.jsxs(te,{direction:"row",spacing:1,alignItems:"center",flexWrap:"wrap",children:[e.jsx(Z,{size:"small",variant:fe?"contained":"outlined",onClick:V,children:"셀 편집"}),fe&&e.jsxs(e.Fragment,{children:[e.jsx(Z,{size:"small",variant:L==="brush"?"contained":"outlined",onClick:()=>B("brush"),children:"한칸"}),e.jsx(Z,{size:"small",variant:L==="area"?"contained":"outlined",onClick:()=>B("area"),children:"영역"}),e.jsx(G,{component:"input",type:"color",value:J,onChange:k=>re(k.target.value),style:{width:36,height:36,border:"1px solid #ccc",borderRadius:4,padding:0}}),e.jsx(ke,{size:"small",label:"셀 색상",value:J,onChange:k=>re(k.target.value),placeholder:"#RRGGBB",error:J.length>0&&!In(J),sx:{width:110}})]})]}),e.jsx(It,{}),e.jsx(te,{direction:"row",spacing:1,alignItems:"center",flexWrap:"wrap",children:e.jsxs(ke,{select:!0,size:"small",label:"팔레트 정렬",value:f,onChange:k=>v(k.target.value),sx:{flex:1,minWidth:160},onFocus:()=>K(1),children:[e.jsx(ce,{value:"count",children:"비중 순"}),e.jsx(ce,{value:"light",children:"색상 계열 · 밝은 → 어두운"}),e.jsx(ce,{value:"dark",children:"색상 계열 · 어두운 → 밝은"})]})}),e.jsxs(te,{direction:"row",spacing:1,alignItems:"center",flexWrap:"wrap",children:[e.jsx(ke,{size:"small",label:"선택 색상",value:C?b.length===0?"":`${b.length}개 선택`:W??"",onChange:()=>{},disabled:!0,sx:{width:100}}),e.jsx(ke,{size:"small",label:"새 색상",value:z,onChange:k=>d(k.target.value),placeholder:"#RRGGBB",error:z.length>0&&!S,sx:{width:100},disabled:we}),e.jsx(G,{component:"input",type:"color",value:S?F:"#000000",onChange:k=>d(k.target.value),style:{width:40,height:40,border:"1px solid #ccc",borderRadius:4,padding:0},disabled:we}),e.jsx(Z,{variant:"contained",size:"small",onClick:N,disabled:!S||we,children:"적용"}),e.jsx(Z,{variant:C?"contained":"outlined",size:"small",onClick:P,children:"선택"})]})]}),e.jsxs(G,{sx:{minHeight:0,overflow:"auto"},children:[i.length===0&&e.jsxs(te,{sx:{p:1.25},spacing:1,alignItems:"center",children:[e.jsx(Pn,{color:"disabled"}),e.jsx(U,{variant:"body2",color:"text.secondary",children:"팔레트가 없습니다. 변환할 이미지를 불러오세요."})]}),i.map(k=>e.jsxs(G,{sx:{display:"flex",alignItems:"center",px:1.25,py:.75,borderBottom:"1px solid",borderColor:"divider",columnGap:1,cursor:"pointer",bgcolor:C&&b.includes(k.hex)||!C&&W===k.hex?"action.selected":"transparent"},ref:!C&&W===k.hex?ae=>{A.current=ae}:void 0,onClick:()=>{C?x(k.hex):m(k.hex)},children:[e.jsx(G,{sx:{width:32,height:32,borderRadius:.75,border:"1px solid",borderColor:"divider",bgcolor:k.hex,flexShrink:0}}),e.jsxs(G,{sx:{flex:1,display:"flex",alignItems:"center",justifyContent:"space-between",gap:1},children:[e.jsx(U,{variant:"body2",fontWeight:700,noWrap:!0,children:k.hex}),e.jsxs(U,{variant:"caption",color:"text.secondary",noWrap:!0,children:[k.count.toLocaleString()," px · ",k.percent,"%"]})]})]},k.hex))]}),ue>1&&e.jsx(G,{sx:{py:1,display:"flex",justifyContent:"center"},children:e.jsx(Es,{count:ue,page:oe,onChange:(k,ae)=>K(ae),color:"primary",size:"small",showFirstButton:!0,showLastButton:!0})})]})},Qs=({open:i,pdfMode:h,onPdfModeChange:f,pdfLoading:v,onClose:C,onDownload:b})=>e.jsxs(zt,{open:i,onClose:C,maxWidth:"sm",fullWidth:!0,children:[e.jsx(Wt,{children:"PDF 다운로드"}),e.jsxs(Dt,{sx:{display:"flex",flexDirection:"column",gap:1.25,pt:1},children:[e.jsxs(te,{spacing:.5,children:[e.jsx(U,{variant:"subtitle2",children:"저장 모드"}),e.jsxs(Is,{row:!0,value:h,onChange:W=>f(W.target.value),children:[e.jsx(Mt,{value:"original",control:e.jsx(jn,{size:"small"}),label:"원본 크기(처리 크기)"}),e.jsx(Mt,{value:"paper",control:e.jsx(jn,{size:"small"}),label:"용지 맞춤"})]}),e.jsx(U,{variant:"caption",color:"text.secondary",children:"원본 크기: 처리된 이미지 크기(px) 그대로 저장 · 용지 맞춤: 선택한 용지에 맞춰 축소/배치"})]}),h==="paper"&&e.jsx(U,{variant:"caption",color:"text.secondary",children:"용지 맞춤은 기본 설정의 용지/방향 값을 사용합니다."}),e.jsx(U,{variant:"caption",color:"text.secondary",children:"현재 설정된 그리드 표시 상태를 그대로 적용해 PDF를 생성합니다."})]}),e.jsxs(Ht,{children:[e.jsx(Z,{onClick:C,disabled:v,children:"취소"}),e.jsx(Z,{onClick:b,variant:"outlined",color:"primary",disabled:v,children:v?"생성 중...":"다운로드"})]})]}),eo=({imageSrc:i,pixelatedSrc:h,error:f,originalSize:v,renderedSize:C,uniqueCount:b,totalPixels:W,viewScale:P,onAdjustScale:x,showGrid:m,onToggleGrid:A,gridColor:z,onGridColorChange:d,gridLineColor:S,cellEditMode:F,cellEditPreview:N,onOpenEdit:oe,onOpenPdf:ue,onDropImage:K,onPreviewClick:fe,onPreviewMouseDown:V,onPreviewMouseUp:J,onPreviewTouch:re,onPreviewMove:L,onPreviewLeave:B,scrollContainerRef:we,previewContainerRef:k,previewImgRef:ae,magnifierCanvasRef:ne,previewHover:ve,magnifierSize:Me,scaledWidth:se,scaledHeight:T,gridCols:he,gridRows:ie,gridCellWidth:xe,gridCellHeight:a})=>e.jsxs(G,{sx:{...sn,flex:1,minWidth:700,minHeight:0},children:[e.jsxs(G,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",px:1.25,py:1.25,borderBottom:"1px solid",borderColor:"divider"},children:[e.jsx(U,{variant:"subtitle1",fontWeight:700,children:"미리보기"}),e.jsxs(te,{direction:"row",spacing:1.5,alignItems:"center",flexWrap:"wrap",justifyContent:"flex-end",children:[e.jsxs(te,{direction:"row",spacing:.5,alignItems:"center",children:[e.jsx(Z,{size:"small",variant:"outlined",onClick:()=>x(-10),disabled:!i,children:"-"}),e.jsxs(U,{variant:"body2",sx:{minWidth:48,textAlign:"center"},children:[P,"%"]}),e.jsx(Z,{size:"small",variant:"outlined",onClick:()=>x(10),disabled:!i,children:"+"})]}),e.jsx(It,{flexItem:!0,orientation:"vertical"}),e.jsx(Mt,{control:e.jsx(Qt,{size:"small",checked:m,onChange:s=>A(s.target.checked)}),label:"그리드",disabled:!i}),m&&e.jsx(G,{component:"input",type:"color",value:z,onChange:s=>d(s.target.value),style:{width:32,height:32,border:"1px solid #ccc",borderRadius:4,padding:0},disabled:!i}),e.jsx(It,{flexItem:!0,orientation:"vertical"}),e.jsx(Z,{size:"small",variant:"outlined",startIcon:e.jsx(zs,{}),onClick:oe,disabled:!i,children:"편집"}),e.jsx(Z,{size:"small",variant:"outlined",startIcon:e.jsx(Ws,{}),onClick:ue,disabled:!h,children:"PDF"})]})]}),e.jsxs(G,{sx:{p:1.25,display:"flex",flexDirection:"column",gap:1.25,flex:1,minHeight:0},onDragOver:s=>s.preventDefault(),onDrop:K,children:[e.jsxs(G,{sx:{flex:1,minWidth:0,width:"100%",maxWidth:"100%",border:"1px dashed",borderColor:i?"divider":"text.disabled",borderRadius:1,bgcolor:"background.default",position:"relative",overflow:"hidden",display:"flex",flexDirection:"column"},children:[!i&&e.jsxs(te,{sx:{inset:0,position:"absolute"},alignItems:"center",justifyContent:"center",spacing:1,children:[e.jsx(Pn,{color:"disabled"}),e.jsx(U,{variant:"body2",color:"text.secondary",children:"이미지를 업로드하세요."})]}),i&&e.jsx(G,{sx:{flex:1,position:"relative",minHeight:0,overflow:"hidden"},children:e.jsx(G,{ref:we,sx:{position:"absolute",inset:12,overflow:"auto",userSelect:"none"},onMouseDown:s=>{F&&(s.preventDefault(),V(s))},onMouseMove:s=>{s.target===s.currentTarget&&L(s)},onMouseUp:J,children:e.jsx(G,{sx:{width:se?`max(100%, ${se}px)`:"100%",height:T?`max(100%, ${T}px)`:"100%",minWidth:"100%",minHeight:"100%",display:"flex",alignItems:"center",justifyContent:"center"},children:h?e.jsxs(G,{ref:k,sx:{position:"relative",width:se??"auto",height:T??"auto",maxWidth:"none",maxHeight:"none",minWidth:se??void 0,minHeight:T??void 0,borderRadius:1,display:"inline-block"},children:[e.jsx(G,{component:"img",ref:ae,src:h,alt:"변환 이미지",draggable:!1,onDragStart:s=>s.preventDefault(),onClick:fe,onMouseDown:s=>{s.preventDefault(),s.stopPropagation(),V(s)},onMouseUp:J,onTouchStart:re,onMouseMove:L,onMouseLeave:B,sx:{width:"100%",height:"100%",maxWidth:"none",maxHeight:"none",imageRendering:"pixelated",display:"block",borderRadius:1,cursor:F?"cell":"crosshair",userSelect:"none",WebkitUserDrag:"none"}}),m&&se&&T&&he>0&&ie>0&&e.jsx(G,{sx:{pointerEvents:"none",position:"absolute",inset:0,borderRadius:1,backgroundImage:`linear-gradient(to right, ${S} 1px, transparent 1px),
                            linear-gradient(to bottom, ${S} 1px, transparent 1px)`,backgroundSize:`${xe??se/he}px ${a??T/ie}px`,backgroundPosition:"0 0"}}),F&&xe&&a&&Object.keys(N).length>0&&e.jsx(G,{component:"svg",sx:{pointerEvents:"none",position:"absolute",inset:0,width:"100%",height:"100%"},children:Object.entries(N).map(([s,u])=>{const[M,g]=s.split(",").map($=>Number($)),y=M*xe,X=g*a;return e.jsx("rect",{x:y,y:X,width:xe,height:a,fill:u,fillOpacity:.45},s)})}),e.jsxs(G,{sx:{pointerEvents:"none",position:"absolute",left:ve.x,top:ve.y,transform:"none",bgcolor:"background.paper",borderRadius:1,boxShadow:3,p:.5,display:ve.visible?"inline-flex":"none",flexDirection:"column",gap:.5,zIndex:2},children:[e.jsx("canvas",{ref:ne,width:Me,height:Me,style:{width:Me,height:Me}}),e.jsx(U,{variant:"caption",color:"text.secondary",sx:{textAlign:"center"},children:ve.color.toUpperCase()})]})]}):e.jsx(U,{variant:"body2",color:"text.secondary",children:"변환된 이미지를 준비하는 중입니다..."})})})})]}),i&&e.jsxs(te,{spacing:.25,direction:"row",justifyContent:"space-between",alignItems:"center",children:[e.jsxs(U,{variant:"caption",color:"text.secondary",children:["원본 크기: ",v.width," x ",v.height,"px",C.width!==v.width||C.height!==v.height?` · 처리 크기: ${C.width} x ${C.height}px`:""]}),e.jsxs(U,{variant:"caption",color:"text.secondary",children:["팔레트 색상: ",b.toLocaleString(),"개 · 픽셀: ",W.toLocaleString(),"개"]})]}),f&&e.jsx(Ds,{severity:"error",children:f})]})]}),to=({inputRef:i,onOpenLink:h,onTriggerUpload:f,onFileSelect:v,imageSrc:C,maxCols:b,blockSize:W,onBlockSizeChange:P,paletteSize:x,onPaletteSizeChange:m,stitchSizeMm:A,onStitchSizeChange:z,paperMarginMm:d,onPaperMarginChange:S,paperMode:F,onPaperModeChange:N,pdfOrientation:oe,onPdfOrientationChange:ue,customPaperWidthInput:K,customPaperHeightInput:fe,onCustomWidthChange:V,onCustomHeightChange:J,lockCustomPaperAspect:re,onLockCustomPaperAspectChange:L,onApplyPaperFit:B,paperWidthMm:we,paperHeightMm:k,usableWidthMm:ae,usableHeightMm:ne,estimatedCols:ve,estimatedRows:Me,gridCols:se,gridRows:T,finalWidthMm:he,finalHeightMm:ie,useOriginalSize:xe,onUseOriginalSizeChange:a})=>e.jsxs(G,{sx:{...sn,width:320,flexShrink:0,minHeight:0},children:[e.jsxs(G,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",px:1.25,py:1.25,borderBottom:"1px solid",borderColor:"divider"},children:[e.jsx(U,{variant:"subtitle1",fontWeight:700,children:"이미지 업로드"}),e.jsx(Z,{size:"small",variant:"outlined",onClick:h,startIcon:e.jsx(Hs,{}),children:"링크"})]}),e.jsxs(G,{sx:{p:1.25,display:"flex",flexDirection:"column",gap:1.25,flex:1,minHeight:0},children:[e.jsxs(te,{spacing:1,children:[e.jsx(Z,{fullWidth:!0,variant:"contained",startIcon:e.jsx(Os,{}),onClick:f,children:"이미지 선택"}),e.jsx(U,{variant:"caption",color:"text.secondary",textAlign:"center",children:"업로드 또는 드래그&드롭"}),e.jsx("input",{type:"file",accept:"image/*",hidden:!0,ref:i,onChange:s=>{const u=s.target.files?.[0];u&&v(u)}})]}),e.jsx(It,{}),e.jsxs(te,{spacing:1,children:[e.jsx(U,{variant:"subtitle2",fontWeight:700,children:"기본 설정"}),e.jsxs(te,{spacing:.75,children:[e.jsx(U,{variant:"caption",color:"text.secondary",children:"가로 도트 개수"}),e.jsxs(te,{direction:"row",spacing:1,alignItems:"center",children:[e.jsx(Fs,{size:"small",min:1,max:b,step:1,value:W,onChange:(s,u)=>{typeof u=="number"&&P(u)},valueLabelDisplay:"auto",sx:{flex:1},disabled:!C}),e.jsx(ke,{size:"small",type:"number",inputProps:{min:1,max:b},value:W,onChange:s=>P(Number(s.target.value)),sx:{width:90},disabled:!C})]})]}),e.jsxs(ke,{select:!0,size:"small",label:"색상 수 제한",value:x,onChange:s=>m(Number(s.target.value)),sx:{minWidth:0},disabled:!C,children:[e.jsx(ce,{value:0,children:"제한 없음 (원본 색)"}),e.jsx(ce,{value:64,children:"64색"}),e.jsx(ce,{value:128,children:"128색"}),e.jsx(ce,{value:256,children:"256색"}),e.jsx(ce,{value:512,children:"512색"}),e.jsx(ce,{value:1024,children:"1024색"}),e.jsx(ce,{value:2048,children:"2048색"}),e.jsx(ce,{value:4096,children:"4096색"}),e.jsx(ce,{value:8192,children:"8192색"}),e.jsx(ce,{value:16384,children:"16384색"}),e.jsx(ce,{value:32768,children:"32768색"}),e.jsx(ce,{value:65536,children:"65536색"})]}),e.jsxs(te,{spacing:1,children:[e.jsx(U,{variant:"subtitle2",children:"칸 크기 · 용지 맞춤"}),e.jsxs(te,{direction:{xs:"column",sm:"row"},spacing:1,children:[e.jsx(ke,{size:"small",label:"1칸 크기 (mm)",type:"number",inputProps:{min:.1,step:.1},value:A,onChange:s=>z(Math.max(.1,Number(s.target.value)))}),e.jsx(ke,{size:"small",label:"여백 (mm)",type:"number",inputProps:{min:0,step:1},value:d,onChange:s=>S(Math.max(0,Number(s.target.value)))})]}),e.jsxs(te,{direction:{xs:"column",sm:"row"},spacing:1,children:[e.jsxs(ke,{select:!0,size:"small",label:"용지 모드",value:F,onChange:s=>N(s.target.value),sx:{minWidth:0},children:[e.jsx(ce,{value:"a5",children:"프리셋 · A5"}),e.jsx(ce,{value:"a4",children:"프리셋 · A4"}),e.jsx(ce,{value:"a3",children:"프리셋 · A3"}),e.jsx(ce,{value:"custom",children:"사용자 정의"})]}),e.jsxs(ke,{select:!0,size:"small",label:"방향",value:oe,onChange:s=>ue(s.target.value),sx:{minWidth:0},children:[e.jsx(ce,{value:"p",children:"세로"}),e.jsx(ce,{value:"l",children:"가로"})]})]}),F==="custom"&&e.jsxs(te,{direction:{xs:"column",sm:"row"},spacing:1,children:[e.jsx(ke,{size:"small",label:"가로 (mm)",value:K,onChange:s=>V(s.target.value),inputProps:{inputMode:"decimal",pattern:"[0-9.]*"}}),e.jsx(ke,{size:"small",label:"세로 (mm)",value:fe,onChange:s=>J(s.target.value),inputProps:{inputMode:"decimal",pattern:"[0-9.]*"}})]}),F==="custom"&&e.jsx(Mt,{control:e.jsx(Qt,{size:"small",checked:re,onChange:s=>L(s.target.checked)}),label:"이미지 비율로 커스텀 용지 비율 고정"}),e.jsx(Z,{variant:"outlined",size:"small",onClick:B,disabled:!C,children:"용지에 맞춰 칸 수 자동 계산"}),e.jsxs(te,{spacing:.5,children:[e.jsxs(U,{variant:"caption",color:"text.secondary",children:["선택한 용지: ",we.toFixed(0)," × ",k.toFixed(0)," mm"]}),e.jsxs(U,{variant:"caption",color:"text.secondary",children:["사용 가능 영역: ",ae.toFixed(1)," × ",ne.toFixed(1)," mm"]}),e.jsxs(U,{variant:"caption",color:"text.secondary",children:["1칸 ",A.toFixed(2)," mm 기준"]}),e.jsxs(U,{variant:"caption",color:"text.secondary",children:["예상: ",ve," × ",Me,"칸"]}),e.jsxs(U,{variant:"caption",color:"text.secondary",children:["현재 설정: ",se," × ",T,"칸"]}),e.jsxs(U,{variant:"caption",color:"text.secondary",children:["완성 약 ",(he/10).toFixed(1)," × ",(ie/10).toFixed(1)," cm"]})]})]}),e.jsx(Mt,{control:e.jsx(Qt,{size:"small",checked:xe,onChange:s=>a(s.target.checked)}),label:"원본 크기로 처리",disabled:!C})]})]})]}),co=()=>{const{imageSrc:i,pixelatedSrc:h,colors:f,uniqueCount:v,totalPixels:C,loading:b,error:W,originalSize:P,renderedSize:x,blockSize:m,setBlockSize:A,useOriginalSize:z,setUseOriginalSize:d,colorOverrides:S,applyColorOverride:F,applyCellOverridesBatch:N,undoCellEdit:oe,canUndoCellEdit:ue,applyColorOverridesBatch:K,paletteSize:fe,setPaletteSize:V,handleDataUrl:J,originalDataUrl:re,renderedCols:L,renderedRows:B,progress:we}=qs(),k=n.useRef(null),ae=n.useRef(null),ne=n.useRef(null),ve=n.useRef(null),Me=n.useRef(null),se=n.useRef(null),T=n.useRef(null),he=n.useRef(null),ie=n.useRef(!1),[xe,a]=n.useState(!1),[s,u]=n.useState(""),[M,g]=n.useState(!1),[y,X]=n.useState(null),[$,p]=n.useState(!1),[R,E]=n.useState(!1),[Y,H]=n.useState("#000000"),[be,De]=n.useState(100),[Ye,He]=n.useState(!1),[ze,Ct]=n.useState("original"),[Ke,st]=n.useState("p"),[D,I]=n.useState("a5"),[Q,ee]=n.useState(!1),[de,Re]=n.useState(null),[ge,me]=n.useState(null),[Pe,$e]=n.useState(""),[Ce,Ot]=n.useState(!1),[ot,Oe]=n.useState([]),[Ge,Ft]=n.useState("count"),[Ne,rt]=n.useState(1),[pe,Lt]=n.useState(!1),[at,zn]=n.useState("#ff5252"),[We,Wn]=n.useState("brush"),[Dn,yt]=n.useState({}),[on,xt]=n.useState(!1),Fe=n.useRef(!1),gt=n.useRef(null),mt=n.useRef({}),Ve=n.useRef(null),Hn=()=>{Lt(t=>{const r=!t;return r||(Fe.current=!1,xt(!1),mt.current={},gt.current=null,Ve.current=null,yt({})),r})},[pt,On]=n.useState(1),[Ze,Fn]=n.useState(20),[Se,Ln]=n.useState("a5"),[jt,rn]=n.useState("210"),[an,Bt]=n.useState("297"),[wt,Bn]=n.useState(!0),[An,St]=n.useState({visible:!1,x:0,y:0,color:"#000000"}),it=100,Je=16,ye=Je*4,Tn=Math.max(1,Math.round((z?P.width:x.width)||512)),ln=x.width?x.height/x.width:P.width?P.height/P.width:1,Qe=L||Math.max(1,m),kt=B||Math.max(1,Math.round(Qe*ln)),At=be/100,cn=x.width&&Qe?x.width/Qe:void 0,lt=cn?Math.max(1,Math.round(cn*At)):void 0,Tt=x.width?lt?Qe*lt:Math.round(x.width*At):void 0,Xt=x.height?lt?kt*lt:Math.round(x.height*At):void 0,Xn=lt,Un=lt,hn=n.useRef({scrollWidth:0,scrollHeight:0,left:0,top:0}),Ut=n.useRef(!0);n.useEffect(()=>{De(100),Ut.current=!0},[i]),n.useEffect(()=>{const t=Me.current;t&&(!Tt||!Xt||requestAnimationFrame(()=>{const r=hn.current,o=Ut.current?.5:r.scrollWidth>0?(r.left+t.clientWidth/2)/r.scrollWidth:.5,l=Ut.current?.5:r.scrollHeight>0?(r.top+t.clientHeight/2)/r.scrollHeight:.5,c=o*t.scrollWidth,w=l*t.scrollHeight,j=Math.max(0,t.scrollWidth-t.clientWidth),O=Math.max(0,t.scrollHeight-t.clientHeight);t.scrollLeft=Math.min(Math.max(c-t.clientWidth/2,0),j),t.scrollTop=Math.min(Math.max(w-t.clientHeight/2,0),O),hn.current={scrollWidth:t.scrollWidth,scrollHeight:t.scrollHeight,left:t.scrollLeft,top:t.scrollTop}}))},[i,Xt,Tt,be]),n.useEffect(()=>{if(!i||(he.current!==i&&(ie.current=!1,he.current=i),ie.current))return;const t=x.width||P.width,r=x.height||P.height;!t||!r||st(t>=r?"l":"p")},[i,P.height,P.width,x.height,x.width]);const Yn=t=>{ie.current=!0,st(t)},ct=n.useMemo(()=>{const t=[...f];if(Ge==="light"||Ge==="dark"){const r=o=>{const l=parseInt(o.slice(1,3),16)/255,c=parseInt(o.slice(3,5),16)/255,w=parseInt(o.slice(5,7),16)/255,j=Math.max(l,c,w),O=Math.min(l,c,w),q=j-O;let _=0;q!==0&&(j===l?_=(c-w)/q%6:j===c?_=(w-l)/q+2:_=(l-c)/q+4,_=Math.round(_*60),_<0&&(_+=360));const le=(j+O)/2,je=q===0?0:q/(1-Math.abs(2*le-1));return{h:_,s:je,l:le}};t.sort((o,l)=>{const c=r(o.hex),w=r(l.hex),j=c.s<.08,O=w.s<.08;return j&&O?Ge==="light"?w.l-c.l:c.l-w.l:j!==O?j?-1:1:c.h!==w.h?c.h-w.h:c.s!==w.s?w.s-c.s:Ge==="light"?w.l-c.l:c.l-w.l})}return t},[f,Ge]),Yt=Math.max(1,Math.ceil(ct.length/it)),$n=n.useMemo(()=>ct.slice((Ne-1)*it,Ne*it),[Ne,it,ct]);n.useEffect(()=>{rt(t=>Math.min(t,Yt))},[Yt]);const Gn=()=>k.current?.click(),Nn=t=>{De(r=>Math.min(300,Math.max(50,Math.round(r+t))))},$t=t=>new Promise((r,o)=>{const l=new FileReader;l.onload=()=>r(String(l.result)),l.onerror=c=>o(c),l.readAsDataURL(t)}),qn=async t=>{const r=await fetch(t);if(!r.ok)throw new Error("이미지를 불러오지 못했습니다.");const o=await r.blob();return $t(new File([o],"remote-image"))},vt=t=>{X(t),g(!0)},_n=()=>{const t=re??i;if(t){if(re&&h){p(!0);return}vt(t)}},Kn=n.useCallback(t=>{t.preventDefault();const r=t.dataTransfer?.files?.[0];r&&$t(r).then(vt).catch(()=>{})},[]),Vn=async()=>{const t=s.trim();if(t)try{const r=await qn(t);vt(r),u(""),a(!1)}catch{u(""),a(!1)}},Zn=async t=>{try{const r=await $t(t);vt(r)}catch{return}},Jn=t=>{J(t),g(!1),X(null)},Qn=()=>{y&&J(y),g(!1),X(null)},es=()=>{g(!1),X(null)},ts=t=>{const r=t==="preview"?h:re??i;r&&(p(!1),vt(r))},ht=n.useCallback(t=>new Promise((r,o)=>{const l=new Image;l.crossOrigin="anonymous",l.onload=()=>r(l),l.onerror=c=>o(c),l.src=t}),[]),ns=n.useCallback(async t=>{if(t.startsWith("data:image/png"))return t;const r=await ht(t),o=document.createElement("canvas");o.width=r.width,o.height=r.height;const l=o.getContext("2d");return l?(l.drawImage(r,0,0),o.toDataURL("image/png")):t},[ht]),Gt=/^#[0-9a-fA-F]{6}$/.test(Y)?Y:"#000000";n.useEffect(()=>{let t=!1;return(async()=>{if(!h){const o=ae.current;o&&(o.width=0,o.height=0);return}try{const o=await ht(h);if(t)return;const l=ae.current;if(!l)return;l.width=o.width,l.height=o.height;const c=l.getContext("2d");if(!c)return;c.imageSmoothingEnabled=!1,c.clearRect(0,0,l.width,l.height),c.drawImage(o,0,0,o.width,o.height)}catch{const o=ae.current;o&&(o.width=0,o.height=0)}})(),()=>{t=!0}},[ht,h]);const ss=n.useCallback(async()=>{if(!h||!x.width||!x.height)return null;const t=await ht(h),r=document.createElement("canvas");r.width=t.width,r.height=t.height;const o=r.getContext("2d");return o?(o.imageSmoothingEnabled=!1,o.drawImage(t,0,0,t.width,t.height),R&&(c=>{const w=L||m||1,j=B||Math.max(1,Math.round(t.height/t.width*w)),O=t.width/w,q=t.height/j;o.strokeStyle=c,o.lineWidth=1;for(let _=0;_<=w;_++){const le=Math.round(_*O);o.beginPath(),o.moveTo(le+.5,0),o.lineTo(le+.5,t.height),o.stroke()}for(let _=0;_<=j;_++){const le=Math.round(_*q);o.beginPath(),o.moveTo(0,le+.5),o.lineTo(t.width,le+.5),o.stroke()}})(Gt),r.toDataURL("image/png")):null},[m,Gt,ht,h,L,B,x.height,x.width,R]),dn=t=>{const r=ct;if(r.length===0)return;const o=t.internal.pageSize.getWidth(),l=t.internal.pageSize.getHeight(),c=Math.max(8,Math.min(16,o*.06)),w=Math.max(8,Math.min(16,l*.06)),j=Math.max(6,Math.min(12,Math.round(o*.04))),O=j+4,q=14,_=j+40,le=Math.max(1,Math.floor((o-c*2+q)/(_+q))),je=(o-c*2-q*(le-1))/le,Xe=Math.max(1,Math.floor((l-w*2)/O))*le;t.addPage(),t.setFontSize(10);let Ee=0;r.forEach(et=>{Ee>=Xe&&(t.addPage(),Ee=0);const ut=Math.floor(Ee/le),ft=Ee%le,tt=c+ft*(je+q),nt=w+ut*O+j;t.setFillColor(et.hex),t.setDrawColor(0),t.rect(tt,nt-j+2,j,j,"F"),t.text(`${et.hex}`,tt+j+4,nt+2),Ee+=1})},os=Math.max(10,Rn(jt,210)),rs=Math.max(10,Rn(an,297)),as={a5:{width:148,height:210},a4:{width:210,height:297},a3:{width:297,height:420}}[D],un=Se==="custom"?{width:os,height:rs}:as,Rt=Math.max(10,un.width),Pt=Math.max(10,un.height),fn=Ke==="p"?Rt:Pt,xn=Ke==="p"?Pt:Rt,gn=Math.max(10,fn-Ze*2),mn=Math.max(10,xn-Ze*2),dt=ln||1,pn=Math.max(1,Math.floor(gn/Math.max(.1,pt))),is=Math.max(1,Math.floor(mn/Math.max(.1,pt*dt))),Nt=Math.max(1,Math.min(pn,is||pn)),ls=Math.max(1,Math.round(Nt*dt)),cs=Qe*pt,hs=kt*pt,ds=()=>{i&&A(Nt)},us=t=>{const r=t.replace(/[^\d.]/g,"");if(rn(r),Se==="custom"&&wt){const o=parseFloat(r);if(!Number.isNaN(o)&&o>0){const l=Math.max(10,Number((o*dt).toFixed(2)));Bt(l.toFixed(2))}}},fs=t=>{const r=t.replace(/[^\d.]/g,"");if(Bt(r),Se==="custom"&&wt){const o=parseFloat(r);if(!Number.isNaN(o)&&o>0){const l=Math.max(10,Number((o/dt).toFixed(2)));rn(l.toFixed(2))}}};n.useEffect(()=>{if(Se==="custom"&&wt){const t=parseFloat(jt);if(!Number.isNaN(t)&&t>0){const r=Math.max(10,Number((t*dt).toFixed(2)));Bt(r.toFixed(2))}}},[dt,jt,wt,Se]),n.useEffect(()=>{(Se==="a5"||Se==="a4"||Se==="a3")&&I(Se)},[Se]);const xs=async()=>{if(i&&!(!h||!x.width||!x.height)){Re(null),ee(!0);try{const t=await ns(i),r=await ss();if(!r)throw new Error("PDF로 변환할 이미지를 준비하지 못했습니다.");if(ze==="original"){const o=x.width>=x.height?"l":"p",l=Math.max(x.width,P.width),c=Math.max(x.height,P.height),w=new yn({orientation:o,unit:"px",format:[l,c]});w.addImage(t,"PNG",0,0,P.width,P.height),w.addPage([x.width,x.height]),w.addImage(r,"PNG",0,0,x.width,x.height),dn(w),w.save("cross-stitch.pdf")}else{const o=Ss=>Ss*.264583,l=new yn({orientation:Ke,unit:"mm",format:Se==="custom"?[Rt,Pt]:D}),c=l.internal.pageSize.getWidth(),w=l.internal.pageSize.getHeight(),j=l.getImageProperties(t),O=o(j.width),q=o(j.height),_=Math.max(1,c-Ze*2),le=Math.max(1,w-Ze*2),je=Math.min(_/O,le/q),Te=O*je,Xe=q*je,Ee=(c-Te)/2,et=(w-Xe)/2;l.addImage(t,"PNG",Ee,et,Te,Xe),l.addPage(Se==="custom"?[Rt,Pt]:D);const ut=l.internal.pageSize.getWidth(),ft=l.internal.pageSize.getHeight(),tt=l.getImageProperties(r),nt=o(tt.width),Et=o(tt.height),Vt=Math.max(1,ut-Ze*2),Ue=Math.max(1,ft-Ze*2),bn=Math.min(Vt/nt,Ue/Et),Mn=nt*bn,Cn=Et*bn,ys=(ut-Mn)/2,js=(ft-Cn)/2;l.addImage(r,"PNG",ys,js,Mn,Cn),dn(l),l.save("cross-stitch.pdf")}He(!1)}catch(t){console.error(t),Re("PDF 생성에 실패했습니다. 잠시 후 다시 시도해주세요.")}finally{ee(!1)}}};n.useEffect(()=>{if(f.length===0){me(null),$e(""),Oe([]);return}rt(1),me(t=>t&&f.some(o=>o.hex===t)?t:f[0].hex),Oe(t=>t.filter(r=>f.some(o=>o.hex===r)))},[f]),n.useEffect(()=>{if(!ge)return;const t=S[ge];$e(t??ge)},[ge,S]);const qt=In(Pe),gs=qt?Pe.startsWith("#")?Pe:`#${Pe}`:"#000000",wn=n.useCallback(t=>{const r=Zs(t);if(!r)return;const o=ct.findIndex(c=>c.hex===r);if(o===-1)return;const l=Math.floor(o/it)+1;rt(l),Ce?Oe(c=>c.includes(r)?c:[...c,r]):(me(r),$e(S[r]??r))},[S,Ce,it,ct]),Le=n.useCallback((t,r,o)=>{if(!h)return null;const l=ne.current,c=ae.current;if(!l||!c||c.width===0||c.height===0)return null;const w=l.getBoundingClientRect();if(w.width===0||w.height===0)return null;let j=(t-w.left)/w.width,O=(r-w.top)/w.height;if(o?.clamp)j=Math.min(1,Math.max(0,j)),O=Math.min(1,Math.max(0,O));else if(j<0||j>1||O<0||O>1)return null;const q=Math.min(c.width-1,Math.max(0,Math.floor(j*c.width))),_=Math.min(c.height-1,Math.max(0,Math.floor(O*c.height))),le=c.getContext("2d");if(!le)return null;const je=le.getImageData(q,_,1,1).data;if(je[3]===0)return null;const Te=Ee=>Ee.toString(16).padStart(2,"0"),Xe=`#${Te(je[0])}${Te(je[1])}${Te(je[2])}`;return(o?.focusPalette??!0)&&(Oe([]),wn(Xe)),{hex:Xe,canvasX:q,canvasY:_}},[wn,h]),Be=n.useCallback((t,r)=>{if(!L||!B)return null;const o=ae.current;if(!o||o.width===0||o.height===0)return null;const l=o.width/L,c=o.height/B,w=Math.min(L-1,Math.max(0,Math.floor(t/l))),j=Math.min(B-1,Math.max(0,Math.floor(r/c)));return{col:w,row:j}},[L,B]),Ae=n.useCallback((t,r)=>{const o=`${t},${r}`;gt.current!==o&&(gt.current=o,mt.current[o]=at,yt(l=>({...l,[o]:at})))},[at]),qe=n.useCallback((t,r)=>{const o=Math.max(0,Math.min(t.col,r.col)),l=Math.max(t.col,r.col),c=Math.max(0,Math.min(t.row,r.row)),w=Math.max(t.row,r.row),j={};for(let O=c;O<=w;O+=1)for(let q=o;q<=l;q+=1)j[`${q},${O}`]=at;mt.current=j,yt(j)},[at]),_e=n.useCallback(async()=>{const t=Object.entries(mt.current).map(([r,o])=>{const[l,c]=r.split(",").map(w=>Number(w));return{col:l,row:c,color:o}});mt.current={},gt.current=null,Ve.current=null,yt({}),t.length>0&&await N(t)},[N]),vn=n.useCallback((t,r)=>{const o=ae.current,l=se.current;if(!o||!l)return;const c=l.getContext("2d");if(!c)return;const w=Math.floor(Je/2),j=Math.max(0,Math.min(o.width-Je,t-w)),O=Math.max(0,Math.min(o.height-Je,r-w));c.imageSmoothingEnabled=!1,c.clearRect(0,0,ye,ye),c.drawImage(o,j,O,Je,Je,0,0,ye,ye),c.strokeStyle="rgba(0,0,0,0.35)",c.lineWidth=1,c.strokeRect(.5,.5,ye-1,ye-1),c.beginPath(),c.moveTo(ye/2,0),c.lineTo(ye/2,ye),c.moveTo(0,ye/2),c.lineTo(ye,ye/2),c.stroke()},[ye,Je]),ms=n.useCallback(t=>{const r=Le(t.clientX,t.clientY,{focusPalette:!pe});if(r&&pe){if(We==="area")return;const o=Be(r.canvasX,r.canvasY);o&&(Ae(o.col,o.row),_e());return}},[pe,We,_e,Be,Le,Ae]),ps=n.useCallback(t=>{if(!pe)return;Fe.current=!0,xt(!0);const r=Le(t.clientX,t.clientY,{focusPalette:!1,clamp:!0});if(!r){Fe.current=!1,xt(!1);return}const o=Be(r.canvasX,r.canvasY);if(o){if(We==="area"){Ve.current=o,gt.current=null,qe(o,o);return}Ae(o.col,o.row)}},[qe,pe,We,Be,Le,Ae]),ws=n.useCallback(()=>{Fe.current&&(Fe.current=!1,xt(!1),_e())},[_e]),vs=n.useCallback(t=>{const r=t.touches[0];if(!r)return;const o=Le(r.clientX,r.clientY,{focusPalette:!pe});if(o&&pe){const l=Be(o.canvasX,o.canvasY);l&&(We==="area"?qe(l,l):Ae(l.col,l.row),_e())}St({visible:!1,x:0,y:0,color:"#000000"})},[qe,pe,We,_e,Be,Le,Ae]),bs=n.useCallback(t=>{const r=Le(t.clientX,t.clientY,{focusPalette:!1,clamp:pe&&Fe.current}),o=ve.current,l=ne.current;if(!r||!o){St(Ue=>Ue.visible?{...Ue,visible:!1}:Ue);return}if(pe&&Fe.current){const Ue=Be(r.canvasX,r.canvasY);Ue&&(We==="area"&&Ve.current?qe(Ve.current,Ue):Ae(Ue.col,Ue.row))}if(!l)return;vn(r.canvasX,r.canvasY);const c=o.getBoundingClientRect(),w=l.getBoundingClientRect(),j=12,O=ye,q=t.clientX-c.left,_=t.clientY-c.top,le=w.left-c.left,je=w.top-c.top,Te=le+w.width,Xe=je+w.height,Ee=le,et=je,ut=Math.max(Ee,Te-O),ft=Math.max(et,Xe-O),tt=q+j+O>Te?q-j-O:q+j,nt=_+j+O>Xe?_-j-O:_+j,Et=Math.min(Math.max(tt,Ee),ut),Vt=Math.min(Math.max(nt,et),ft);St({visible:!0,x:Et,y:Vt,color:r.hex})},[qe,pe,We,vn,Be,Le,Ae]),Ms=n.useCallback(()=>{St(t=>t.visible?{...t,visible:!1}:t)},[]),_t=n.useCallback(t=>{if(!Fe.current)return;const r=Le(t.clientX,t.clientY,{focusPalette:!1,clamp:!0});if(r&&pe){const o=Be(r.canvasX,r.canvasY);o&&(We==="area"&&Ve.current?qe(Ve.current,o):Ae(o.col,o.row))}},[qe,pe,We,Be,Le,Ae]),Kt=n.useCallback(()=>{Fe.current&&(Fe.current=!1,xt(!1),_e())},[_e]);n.useEffect(()=>{if(on)return window.addEventListener("mousemove",_t),window.addEventListener("mouseup",Kt),()=>{window.removeEventListener("mousemove",_t),window.removeEventListener("mouseup",Kt)}},[_t,Kt,on]),n.useEffect(()=>{const t=r=>{if(!((r.metaKey||r.ctrlKey)&&r.key.toLowerCase()==="z"))return;const l=r.target,c=l?.tagName?.toLowerCase();c==="input"||c==="textarea"||l?.isContentEditable||ue&&(r.preventDefault(),oe())};return window.addEventListener("keydown",t),()=>window.removeEventListener("keydown",t)},[ue,oe]);const Cs=async()=>{if(!qt)return;const t=Pe.startsWith("#")?Pe:`#${Pe}`;if(Ce){if(ot.length===0)return;await K(ot,t)}else{if(!ge)return;await F(ge,t)}$e(t)};return e.jsxs(e.Fragment,{children:[e.jsxs(Ls,{sx:{p:1.25,display:"flex",flexDirection:"column",gap:1.25,flex:1,minHeight:785,height:"100%",width:1,maxWidth:"100%",overflowX:"hidden"},children:[e.jsxs(te,{direction:"row",spacing:1.25,sx:{width:"100%",maxWidth:"100%",minHeight:785,height:"calc(100vh - 190px)"},children:[e.jsx(to,{inputRef:k,onOpenLink:()=>a(!0),onTriggerUpload:Gn,onFileSelect:t=>void Zn(t),imageSrc:i,maxCols:Tn,blockSize:m,onBlockSizeChange:A,paletteSize:fe,onPaletteSizeChange:V,stitchSizeMm:pt,onStitchSizeChange:On,paperMarginMm:Ze,onPaperMarginChange:Fn,paperMode:Se,onPaperModeChange:Ln,pdfOrientation:Ke,onPdfOrientationChange:Yn,customPaperWidthInput:jt,customPaperHeightInput:an,onCustomWidthChange:us,onCustomHeightChange:fs,lockCustomPaperAspect:wt,onLockCustomPaperAspectChange:Bn,onApplyPaperFit:ds,paperWidthMm:fn,paperHeightMm:xn,usableWidthMm:gn,usableHeightMm:mn,estimatedCols:Nt,estimatedRows:ls,gridCols:Qe,gridRows:kt,finalWidthMm:cs,finalHeightMm:hs,useOriginalSize:z,onUseOriginalSizeChange:d}),e.jsx(eo,{imageSrc:i,pixelatedSrc:h,error:de??W,originalSize:P,renderedSize:x,uniqueCount:v,totalPixels:C,viewScale:be,onAdjustScale:Nn,showGrid:R,onToggleGrid:E,gridColor:Y,onGridColorChange:H,gridLineColor:Gt,cellEditMode:pe,cellEditPreview:Dn,onOpenEdit:_n,gridCellWidth:Xn,gridCellHeight:Un,onOpenPdf:()=>He(!0),onDropImage:Kn,onPreviewClick:ms,onPreviewMouseDown:ps,onPreviewMouseUp:ws,onPreviewTouch:vs,onPreviewMove:bs,onPreviewLeave:Ms,scrollContainerRef:Me,previewContainerRef:ve,previewImgRef:ne,magnifierCanvasRef:se,previewHover:An,magnifierSize:ye,scaledWidth:Tt,scaledHeight:Xt,gridCols:Qe,gridRows:kt}),e.jsx(Js,{palette:$n,uniqueCount:v,paletteSort:Ge,onSortChange:Ft,multiSelectMode:Ce,multiSelection:ot,selectedPalette:ge,onToggleSelectMode:()=>{Ot(t=>!t),Oe([])},onToggleSelection:t=>Oe(r=>r.includes(t)?r.filter(o=>o!==t):[...r,t]),onSelectPalette:t=>{me(t),$e(S[t]??t)},selectedSwatchRef:T,overrideHex:Pe,onOverrideHexChange:$e,overrideIsValid:qt,overrideColorValue:gs,onApplyOverride:Cs,palettePage:Ne,palettePageCount:Yt,onPalettePageChange:rt,cellEditMode:pe,onToggleCellEditMode:Hn,cellEditColor:at,onCellEditColorChange:zn,cellEditTool:We,onCellEditToolChange:Wn})]}),e.jsx(Ks,{open:xe,linkValue:s,onClose:()=>a(!1),onChange:u,onSubmit:Vn}),e.jsx(_s,{open:$,onClose:()=>p(!1),onSelect:ts}),e.jsx(Vs,{open:M,dataUrl:y,onApply:Jn,onSkip:Qn,onCancel:es}),e.jsx(Qs,{open:Ye,pdfMode:ze,onPdfModeChange:Ct,pdfLoading:Q,onClose:()=>He(!1),onDownload:xs})]}),e.jsx("canvas",{ref:ae,style:{display:"none"}}),e.jsx(Bs,{open:b,sx:{color:"#fff",zIndex:t=>t.zIndex.tooltip+1},children:e.jsxs(te,{alignItems:"center",spacing:1,children:[e.jsx(As,{color:"inherit"}),e.jsx(U,{variant:"body2",children:"이미지를 처리하는 중입니다…"}),e.jsxs(U,{variant:"caption",children:[we.toFixed(0),"%"]})]})})]})};export{co as default};
