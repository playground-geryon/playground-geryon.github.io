import{r as n,j as e,E as yn}from"./vendor-DyxFRNuv.js";import{l as zt,m as Wt,n as Dt,S as te,T as U,p as Ht,a as Z,o as ke,B as G,bD as Rs,bE as Ps,Y as Es,h as It,a7 as ce,av as En,aS as Is,as as zs,ab as bt,at as Sn,ac as Qt,bj as Ws,bl as Ds,a1 as Hs,bF as Os,bv as Fs,aw as Ls,P as Bs,br as As,C as Ts}from"./mui-Dn-s4uu_.js";import"./excel-CUMakpxJ.js";import"./tree-sitter-DJeWk4Ia.js";const en=800,In=i=>new Promise((h,f)=>{const v=new FileReader;v.onload=()=>h(String(v.result)),v.onerror=C=>f(C),v.readAsDataURL(i)}),Xs=i=>new Promise((h,f)=>{const v=new Image;v.crossOrigin="anonymous",v.onload=()=>h(v),v.onerror=C=>f(C),v.src=i}),Zt=i=>i.toString(16).padStart(2,"0"),nn=(i,h,f)=>`#${Zt(i)}${Zt(h)}${Zt(f)}`,Us=async i=>{const h=await fetch(i,{mode:"cors"});if(!h.ok)throw new Error("이미지를 불러오지 못했습니다.");const f=await h.blob();return In(new File([f],"remote-image"))},Jt=(i,h)=>{const v=255/(2**h-1),C=Math.round(i/v)*v;return Math.max(0,Math.min(255,Math.round(C)))},Ys=(i,h)=>{if(h===0)return i;const f=parseInt(i.slice(1,3),16),v=parseInt(i.slice(3,5),16),C=parseInt(i.slice(5,7),16),M=h===8?{r:3,g:3,b:2}:h===16?{r:5,g:6,b:5}:{r:8,g:8,b:8},W=Jt(f,M.r),P=Jt(v,M.g),x=Jt(C,M.b);return nn(W,P,x)},Mt=i=>{const h=i.trim().replace(/^#/,"");return/^[0-9a-fA-F]{6}$/.test(h)?`#${h.toLowerCase()}`:null},kn=(i,h)=>{const f=Mt(i);if(!f)return null;if(h[f])return f;const v=Object.entries(h).find(([,C])=>C===f);return v?v[0]:f},$s=(i,h)=>h[i]??i,tn=i=>({r:parseInt(i.slice(1,3),16),g:parseInt(i.slice(3,5),16),b:parseInt(i.slice(5,7),16)}),Gs=32,Rn=(i,h)=>(i.r-h.r)**2+(i.g-h.g)**2+(i.b-h.b)**2,Ns=(i,h=Gs)=>{const f=i.map(M=>({...tn(M.hex),count:M.count}));if(!f.length)return[];let v=[{items:f}];const C=M=>{if(M.items.length<=1)return[M];const W=["r","g","b"].map(S=>{const F=M.items.map(N=>N[S]);return Math.max(...F)-Math.min(...F)}),P=W.indexOf(Math.max(...W)),x=["r","g","b"][P],m=[...M.items].sort((S,F)=>S[x]-F[x]),A=m.reduce((S,F)=>S+F.count,0);let z=0,d=0;for(;d<m.length&&(z+=m[d].count,!(z>=A/2));d++);if(d<=0||d>=m.length-1){const S=Math.floor(m.length/2);return[{items:m.slice(0,S)},{items:m.slice(S)}]}return[{items:m.slice(0,d+1)},{items:m.slice(d+1)}]};for(;v.length<h;){v.sort((x,m)=>m.items.length-x.items.length);const M=v.shift();if(!M)break;if(M.items.length<=1){v.push(M);break}const[W,P]=C(M);if(v.push(W),v.push(P),v.length>=h)break}return v.map(M=>{const W=M.items.reduce((A,z)=>A+z.count,0);if(!W)return null;const P=Math.round(M.items.reduce((A,z)=>A+z.r*z.count,0)/W),x=Math.round(M.items.reduce((A,z)=>A+z.g*z.count,0)/W),m=Math.round(M.items.reduce((A,z)=>A+z.b*z.count,0)/W);return{hex:nn(P,x,m),count:W,percent:0}}).filter(M=>!!M).sort((M,W)=>W.count-M.count)},qs=async(i,h,f,v,C,M,W,P,x)=>{const m=await Xs(i),A=C?1:Math.min(en/Math.max(m.width,m.height),1),z=Math.max(1,Math.round(m.width*A)),d=Math.max(1,Math.round(m.height*A)),S=Math.max(1,Math.min(Math.round(h),z)),F=Math.max(1,Math.round(d/z*S)),N=document.createElement("canvas");N.width=z,N.height=d;const oe=N.getContext("2d",{willReadFrequently:!0});if(!oe)throw new Error("캔버스를 초기화할 수 없습니다.");oe.drawImage(m,0,0,z,d);const ue=Math.max(1,Math.floor(en/Math.max(S,F))),K=S*ue,fe=F*ue,V=document.createElement("canvas");V.width=K,V.height=fe;const J=V.getContext("2d");if(!J)throw new Error("캔버스를 초기화할 수 없습니다.");const ae=J.createImageData(K,fe),L=new Map,B=[],we="#ffffff",k=z/S,re=d/F,ne=K/S,ve=fe/F;x(10),B.length=0,L.clear();const be=F*S;for(let r=0;r<F;r++){for(let u=0;u<S;u++){const b=Math.floor(u*k),g=Math.floor(r*re),j=Math.min(z,Math.floor((u+1)*k)),X=Math.min(d,Math.floor((r+1)*re)),$=Math.max(1,j-b),p=Math.max(1,X-g),R=oe.getImageData(b,g,$,p).data,E=new Map;for(let I=0;I<R.length;I+=4){if(R[I+3]===0)continue;const ee=R[I]<<16|R[I+1]<<8|R[I+2];E.set(ee,(E.get(ee)??0)+1)}let Y=-1,H=0;E.forEach((I,Q)=>{I>H&&(H=I,Y=Q)});const Me=H>0?nn(Y>>16&255,Y>>8&255,Y&255):we,Ye=Ys(Me,f),He=Math.round(u*ne),ze=Math.round(r*ve),Ct=Math.round((u+1)*ne),Ke=Math.round((r+1)*ve),st=Math.max(1,Ct-He),D=Math.max(1,Ke-ze);B.push({key:`${u},${r}`,x0:He,y0:ze,cellPixW:st,cellPixH:D,hex:Ye}),L.set(Ye,(L.get(Ye)??0)+st*D)}const s=(r+1)*S/be;x(Math.min(90,10+s*80))}J.putImageData(ae,0,0);const se=K*fe;let T=Array.from(L.entries()).map(([r,s])=>({hex:r,count:s,percent:0})),he=[];P>0&&T.length>P&&(T=Ns(T,P),he=T.map(r=>({hex:r.hex,rgb:tn(r.hex)})));const ie=r=>{if(!he.length)return r;const s=tn(r);let u=he[0],b=Rn(s,u.rgb);for(const g of he.slice(1)){const j=Rn(s,g.rgb);j<b&&(b=j,u=g)}return u.hex};L.clear(),B.forEach(({key:r,x0:s,y0:u,cellPixW:b,cellPixH:g,hex:j})=>{const X=he.length?ie(j):j,$=W[r],p=$||$s(X,M);L.set(p,(L.get(p)??0)+b*g);for(let R=0;R<g;R++)for(let E=0;E<b;E++){const Y=((u+R)*K+(s+E))*4;ae.data[Y]=parseInt(p.slice(1,3),16),ae.data[Y+1]=parseInt(p.slice(3,5),16),ae.data[Y+2]=parseInt(p.slice(5,7),16),ae.data[Y+3]=255}}),J.putImageData(ae,0,0),T=Array.from(L.entries()).map(([r,s])=>({hex:r,count:s,percent:Number((s/se*100).toFixed(2))})).sort((r,s)=>s.count-r.count);const xe=V.toDataURL("image/png");return v(null),x(100),{pixelatedSrc:xe,colors:T,totalPixels:se,uniqueCount:T.length,originalSize:{width:m.width,height:m.height},renderedSize:{width:K,height:fe},colCount:S,rowCount:F}},_s=()=>{const[i,h]=n.useState(null),[f,v]=n.useState(null),[C,M]=n.useState(null),[W,P]=n.useState([]),[x,m]=n.useState(0),[A,z]=n.useState(0),[d,S]=n.useState(!1),[F,N]=n.useState(null),[oe,ue]=n.useState({width:0,height:0}),[K,fe]=n.useState({width:0,height:0}),[V,J]=n.useState(0),[ae,L]=n.useState(0),[B,we]=n.useState(112),[k,re]=n.useState(32),[ne,ve]=n.useState(!1),[be,se]=n.useState(0),[T,he]=n.useState({}),[ie,xe]=n.useState({}),r=n.useRef([]),[s,u]=n.useState(!1),[b,g]=n.useState("count"),[j,X]=n.useState(0),$=n.useRef(null),p=n.useRef(0),R=n.useRef(B);n.useEffect(()=>{if(typeof Worker>"u")return;const D=new Worker(new URL("/assets/cross-stitch-worker-DMERlEjB.js",import.meta.url),{type:"module"});return $.current=D,()=>{D.terminate(),$.current=null}},[]);const E=n.useCallback(async(D,I,Q,ee,de,Re,ge)=>{S(!0),N(null),se(0);try{const me=$.current,Pe=p.current+1;p.current=Pe;const $e=()=>new Promise((Ot,ot)=>{if(!me)return ot(new Error("worker unavailable"));const Oe=Ge=>{const{id:Ft,type:Ne,value:at,payload:pe,message:Lt}=Ge.data||{};if(Ft===Pe){if(Ne==="progress"){se(at);return}if(Ne==="result"){me.removeEventListener("message",Oe),Ot(pe);return}Ne==="error"&&(me.removeEventListener("message",Oe),ot(new Error(Lt||"이미지 처리 중 오류가 발생했습니다.")))}};me.addEventListener("message",Oe),me.postMessage({id:Pe,payload:{dataUrl:D,colCountInput:I,bitDepth:Q,useOriginalSize:ee,overrides:de,cellOverrides:Re,paletteSize:ge}})});let Ce;try{Ce=await $e()}catch{Ce=await qs(D,I,Q,N,ee,de,Re,ge,se)}M(Ce.pixelatedSrc),P(Ce.colors),m(Ce.uniqueCount),z(Ce.totalPixels),ue(Ce.originalSize),fe(Ce.renderedSize),J(Ce.colCount),L(Ce.rowCount)}catch(me){N(me?.message??"이미지 처리 중 오류가 발생했습니다."),P([]),m(0),z(0),M(null)}finally{S(!1),se(100)}},[]),Y=D=>{N(null),h(D),v(D),M(null),P([]),m(0),z(0),he({}),xe({}),r.current=[],u(!1)},H=async D=>{try{const I=await In(D);Y(I)}catch(I){N(I?.message??"이미지를 불러오는 중 문제가 발생했습니다.")}},Me=async D=>{try{const I=await Us(D);Y(I)}catch(I){N(I?.message??"이미지 URL을 불러오는 중 문제가 발생했습니다.")}};n.useEffect(()=>{f&&(R.current!==B&&(R.current=B,xe({}),r.current=[],u(!1)),E(f,B,k,ne,T,ie,j))},[B,ie,k,T,b,j,ne,f,E]);const De=()=>{const D=ne?oe.width:K.width;return Math.max(1,Math.round(D||en))};return{imageSrc:i,pixelatedSrc:C,colors:W,uniqueCount:x,totalPixels:A,loading:d,error:F,originalSize:oe,renderedSize:K,blockSize:B,setBlockSize:D=>{const I=Math.min(De(),Math.max(1,Math.round(D)));we(I)},colorBit:k,setColorBit:re,useOriginalSize:ne,setUseOriginalSize:ve,colorOverrides:T,cellOverrides:ie,applyColorOverride:async(D,I)=>{const Q=kn(D,T),ee=Mt(I);if(!Q||!ee){N("HEX 색상 코드를 #RRGGBB 형태로 입력하세요.");return}const de={...T,[Q]:ee};he(de),f&&await E(f,B,k,ne,de,ie,j)},applyCellOverride:async(D,I,Q)=>{const ee=Mt(Q);if(!ee){N("HEX 색상 코드를 #RRGGBB 형태로 입력하세요.");return}const de=`${D},${I}`,Re={...ie,[de]:ee};r.current.push([{key:de,prev:ie[de]}]),u(!0),xe(Re),f&&await E(f,B,k,ne,T,Re,j)},applyCellOverridesBatch:async D=>{if(D.length===0)return;const I={...ie},Q=[];D.forEach(({col:ee,row:de,color:Re})=>{const ge=Mt(Re);if(!ge)return;const me=`${ee},${de}`;I[me]!==ge&&(Q.push({key:me,prev:I[me]}),I[me]=ge)}),Q.length!==0&&(r.current.push(Q),u(!0),xe(I),f&&await E(f,B,k,ne,T,I,j))},undoCellEdit:async()=>{const D=r.current,I=D.pop();if(!I)return;const Q={...ie};I.forEach(({key:ee,prev:de})=>{de?Q[ee]=de:delete Q[ee]}),xe(Q),u(D.length>0),f&&await E(f,B,k,ne,T,Q,j)},canUndoCellEdit:s,applyColorOverridesBatch:async(D,I)=>{const Q=Mt(I);if(!Q){N("HEX 색상 코드를 #RRGGBB 형태로 입력하세요.");return}const ee={...T};let de=!1;for(const Re of D){const ge=kn(Re,ee);ge&&(ee[ge]=Q,de=!0)}de&&(he(ee),f&&await E(f,B,k,ne,ee,ie,j))},extractionMode:b,setExtractionMode:g,paletteSize:j,setPaletteSize:X,handleDataUrl:Y,handleFile:H,handleUrl:Me,originalDataUrl:f,renderedCols:V,renderedRows:ae,progress:be}},Ks=({open:i,onClose:h,onSelect:f})=>e.jsxs(zt,{open:i,onClose:h,maxWidth:"xs",fullWidth:!0,children:[e.jsx(Wt,{children:"편집 대상 선택"}),e.jsx(Dt,{children:e.jsx(te,{spacing:1,children:e.jsx(U,{variant:"body2",color:"text.secondary",children:"원본 이미지 또는 현재 미리보기를 선택해 편집할 수 있습니다."})})}),e.jsxs(Ht,{children:[e.jsx(Z,{onClick:h,children:"취소"}),e.jsx(Z,{variant:"outlined",onClick:()=>f("original"),children:"원본"}),e.jsx(Z,{variant:"contained",onClick:()=>f("preview"),children:"미리보기"})]})]}),Vs=({open:i,linkValue:h,onClose:f,onChange:v,onSubmit:C})=>e.jsxs(zt,{open:i,onClose:f,maxWidth:"sm",fullWidth:!0,children:[e.jsx(Wt,{children:"이미지 링크로 불러오기"}),e.jsx(Dt,{children:e.jsx(ke,{autoFocus:!0,fullWidth:!0,label:"이미지 URL",placeholder:"https://example.com/image.png",value:h,onChange:M=>v(M.target.value),variant:"outlined",size:"small",margin:"dense"})}),e.jsxs(Ht,{children:[e.jsx(Z,{onClick:f,children:"취소"}),e.jsx(Z,{onClick:C,variant:"contained",disabled:!h.trim(),autoFocus:!0,children:"불러오기"})]})]}),Ie=(i,h,f)=>Math.min(Math.max(i,h),f),Zs=({open:i,dataUrl:h,onApply:f,onSkip:v,onCancel:C})=>{const M=n.useRef(null),W=n.useRef(null),P=n.useRef(null),x=n.useRef(null),m=n.useRef({mode:"none",offsetX:0,offsetY:0}),[A,z]=n.useState(0),[d,S]=n.useState(null),[F,N]=n.useState({w:0,h:0,scale:1}),[oe,ue]=n.useState(!1),[K,fe]=n.useState({w:0,h:0}),[V,J]=n.useState(null),ae=(r,s)=>{const u=Math.max(4,6/F.scale),b=Math.max(3,4/F.scale),g=Math.abs(r.x-s.x),j=Math.abs(r.x-(s.x+s.w)),X=Math.abs(r.y-s.y),$=Math.abs(r.y-(s.y+s.h)),p=g<=b,R=j<=b,E=X<=b,Y=$<=b;let H="none";p&&E?H="nw":R&&E?H="ne":p&&Y?H="sw":R&&Y&&(H="se");let Me=!1,De=!1,Ye=!1,He=!1;if(H!=="none")return Me=H==="nw"||H==="sw",De=H==="ne"||H==="se",Ye=H==="nw"||H==="ne",He=H==="sw"||H==="se",{left:Me,right:De,top:Ye,bottom:He,corner:H};const ze=Math.min(g,j,X,$);return ze>u?{left:!1,right:!1,top:!1,bottom:!1,corner:"none"}:ze===g?{left:!0,right:!1,top:!1,bottom:!1,corner:"none"}:ze===j?{left:!1,right:!0,top:!1,bottom:!1,corner:"none"}:ze===X?{left:!1,right:!1,top:!0,bottom:!1,corner:"none"}:{left:!1,right:!1,top:!1,bottom:!0,corner:"none"}},L=n.useMemo(()=>!K.w||!K.h?{w:0,h:0}:A%180===0?{w:K.w,h:K.h}:{w:K.h,h:K.w},[A,K]),B=n.useCallback(()=>{const r=P.current;if(!r)return;const{w:s,h:u}=L,b=document.createElement("canvas");b.width=s,b.height=u;const g=b.getContext("2d");g&&(g.save(),A===90?(g.translate(s,0),g.rotate(Math.PI/2)):A===180?(g.translate(s,u),g.rotate(Math.PI)):A===270&&(g.translate(0,u),g.rotate(3*Math.PI/2)),g.drawImage(r,0,0),g.restore(),x.current=b)},[A,L]),we=n.useCallback(()=>{const r=M.current,s=W.current,u=x.current;if(!r||!s||!u)return;const b=Math.max(240,Math.min(640,s.clientWidth||640)),j=Math.min(b/u.width,360/u.height,1),X=Math.round(u.width*j),$=Math.round(u.height*j);r.width=X,r.height=$,r.style.width=`${X}px`,r.style.height=`${$}px`;const p=r.getContext("2d");if(p){if(p.clearRect(0,0,X,$),p.imageSmoothingEnabled=!1,p.drawImage(u,0,0,X,$),d){const R=d.x*j,E=d.y*j,Y=d.w*j,H=d.h*j,Me=m.current.mode==="resize"?m.current.edges:V,De="#1976d2";p.save(),p.strokeStyle="#2e7d32",p.lineWidth=2,p.strokeRect(R+.5,E+.5,Y-1,H-1),Me&&(p.strokeStyle=De,p.lineWidth=3,Me.top&&(p.beginPath(),p.moveTo(R,E),p.lineTo(R+Y,E),p.stroke()),Me.bottom&&(p.beginPath(),p.moveTo(R,E+H),p.lineTo(R+Y,E+H),p.stroke()),Me.left&&(p.beginPath(),p.moveTo(R,E),p.lineTo(R,E+H),p.stroke()),Me.right&&(p.beginPath(),p.moveTo(R+Y,E),p.lineTo(R+Y,E+H),p.stroke())),p.fillStyle="rgba(0,0,0,0.2)",p.fillRect(0,0,X,E),p.fillRect(0,E+H,X,$-E-H),p.fillRect(0,E,R,H),p.fillRect(R+Y,E,X-R-Y,H),p.restore()}N({w:X,h:$,scale:j})}},[d]);n.useEffect(()=>{if(!h||!i)return;const r=new Image;r.onload=()=>{P.current=r,fe({w:r.width,h:r.height}),z(0),S({x:0,y:0,w:r.width,h:r.height})},r.src=h},[h,i]),n.useEffect(()=>{if(!P.current)return;B();const{w:r,h:s}=L;S(u=>u?{x:0,y:0,w:r,h:s}:{x:0,y:0,w:r,h:s})},[B,L]),n.useEffect(()=>{we()},[we,d,A,i]);const k=(r,s)=>{const u=M.current;if(!u)return null;const b=u.getBoundingClientRect(),g=(r-b.left)/F.scale,j=(s-b.top)/F.scale;return{x:g,y:j}},re=r=>{if(!x.current)return;const s=k(r.clientX,r.clientY);if(s){if(ue(!0),d){const u=Math.round(d.x)===0&&Math.round(d.y)===0&&Math.round(d.w)===Math.round(x.current.width)&&Math.round(d.h)===Math.round(x.current.height),b=ae(s,d),g=(b.left||b.right||b.top||b.bottom)&&!u,j=s.x>=d.x&&s.x<=d.x+d.w&&s.y>=d.y&&s.y<=d.y+d.h;if(g){m.current={mode:"resize",offsetX:s.x,offsetY:s.y,edges:b,startRect:{...d}};return}if(j&&!u){m.current={mode:"drag",offsetX:s.x-d.x,offsetY:s.y-d.y};return}}m.current={mode:"new",offsetX:s.x,offsetY:s.y},S({x:s.x,y:s.y,w:1,h:1})}},ne=r=>{if(!x.current)return;const s=x.current,u={x:Ie(r.x,0,s.width),y:Ie(r.y,0,s.height)};if(m.current.mode==="drag"&&d){const b=Ie(u.x-m.current.offsetX,0,s.width-d.w),g=Ie(u.y-m.current.offsetY,0,s.height-d.h);S({...d,x:b,y:g});return}if(m.current.mode==="resize"&&d){const b=m.current.edges,g=m.current.startRect??d;if(!b)return;let j=g.x,X=g.y,$=g.w,p=g.h;if(b.left){const R=g.x+g.w-1;j=Ie(u.x,0,R),$=R-j}if(b.right){const R=g.x+1;$=Ie(u.x,R,s.width)-g.x}if(b.top){const R=g.y+g.h-1;X=Ie(u.y,0,R),p=R-X}if(b.bottom){const R=g.y+1;p=Ie(u.y,R,s.height)-g.y}S({x:j,y:X,w:Math.max(1,$),h:Math.max(1,p)});return}if(m.current.mode==="new"){const b=m.current.offsetX,g=m.current.offsetY,j=Ie(b,0,s.width),X=Ie(g,0,s.height),$=Ie(u.x,0,s.width),p=Ie(u.y,0,s.height),R=Math.min(j,$),E=Math.min(X,p),Y=Math.max(1,Math.abs($-j)),H=Math.max(1,Math.abs(p-X));S({x:R,y:E,w:Y,h:H});return}},ve=r=>{if(!x.current)return;const s=k(r.clientX,r.clientY);if(!s)return;if(m.current.mode!=="none"){ne(s);return}const u=x.current;if(m.current.mode==="none"&&d){if(Math.round(d.x)===0&&Math.round(d.y)===0&&Math.round(d.w)===Math.round(u.width)&&Math.round(d.h)===Math.round(u.height)){J(null);return}const g=ae(s,d);g.left||g.right||g.top||g.bottom?J(g):J(null)}},be=()=>{m.current={mode:"none",offsetX:0,offsetY:0},ue(!1)},se=n.useCallback(r=>{if(!oe)return;const s=k(r.clientX,r.clientY);s&&ne(s)},[oe]),T=n.useCallback(()=>{oe&&(m.current={mode:"none",offsetX:0,offsetY:0},ue(!1))},[oe]);n.useEffect(()=>{if(oe)return window.addEventListener("mousemove",se),window.addEventListener("mouseup",T),()=>{window.removeEventListener("mousemove",se),window.removeEventListener("mouseup",T)}},[oe,se,T]);const he=r=>{z(s=>(s+(r==="left"?-90:90)+360)%360)},ie=()=>{const r=P.current;r&&(z(0),S({x:0,y:0,w:r.width,h:r.height}))},xe=()=>{const r=x.current;if(!r||!d)return;const s=document.createElement("canvas");s.width=Math.round(d.w),s.height=Math.round(d.h);const u=s.getContext("2d");u&&(u.drawImage(r,Math.round(d.x),Math.round(d.y),Math.round(d.w),Math.round(d.h),0,0,Math.round(d.w),Math.round(d.h)),f(s.toDataURL("image/png")))};return e.jsxs(zt,{open:i,onClose:C,maxWidth:"md",fullWidth:!0,children:[e.jsx(Wt,{children:"이미지 자르기/회전"}),e.jsx(Dt,{children:e.jsxs(te,{spacing:1.5,children:[e.jsx(U,{variant:"body2",color:"text.secondary",children:"이미지 영역을 드래그해 선택한 뒤 적용하세요."}),e.jsx(G,{ref:W,sx:{border:"1px solid",borderColor:"divider",borderRadius:1,p:1,display:"flex",alignItems:"center",justifyContent:"center",bgcolor:"background.default",minHeight:360},children:e.jsx("canvas",{ref:M,onMouseDown:re,onMouseMove:ve,onMouseUp:be,onMouseLeave:()=>J(null),style:{cursor:V?V.corner==="nw"||V.corner==="se"?"nwse-resize":V.corner==="ne"||V.corner==="sw"?"nesw-resize":V.top||V.bottom?"n-resize":V.left||V.right?"e-resize":"crosshair":m.current.mode==="drag"?"move":"crosshair"}})}),e.jsxs(te,{direction:"row",spacing:1,alignItems:"center",flexWrap:"wrap",children:[e.jsx(Z,{variant:"outlined",size:"small",startIcon:e.jsx(Rs,{}),onClick:()=>he("left"),children:"왼쪽 회전"}),e.jsx(Z,{variant:"outlined",size:"small",startIcon:e.jsx(Ps,{}),onClick:()=>he("right"),children:"오른쪽 회전"}),e.jsx(Z,{variant:"text",size:"small",onClick:ie,children:"전체 선택"}),e.jsxs(U,{variant:"caption",color:"text.secondary",children:["현재 크기: ",L.w," × ",L.h,"px"]})]})]})}),e.jsxs(Ht,{children:[e.jsx(Z,{onClick:C,children:"취소"}),e.jsx(Z,{onClick:v,variant:"outlined",children:"원본 사용"}),e.jsx(Z,{onClick:xe,variant:"contained",children:"적용"})]})]})},sn={border:"1px solid",borderColor:"divider",borderRadius:1.5,bgcolor:"background.paper",display:"flex",flexDirection:"column",overflow:"hidden",maxWidth:"100%"},on={display:"flex",alignItems:"center",justifyContent:"space-between",px:1.25,py:1.25,minHeight:52,borderBottom:"1px solid",borderColor:"divider"},zn=i=>/^#?[0-9a-fA-F]{6}$/.test(i.trim()),Js=i=>{const h=i.trim().replace(/^#/,"").toLowerCase();return/^[0-9a-f]{6}$/.test(h)?`#${h}`:null},Pn=(i,h)=>{const f=parseFloat(i);return Number.isNaN(f)||f<=0?h:f},Qs=({palette:i,uniqueCount:h,paletteSort:f,onSortChange:v,multiSelectMode:C,multiSelection:M,selectedPalette:W,onToggleSelectMode:P,onToggleSelection:x,onSelectPalette:m,selectedSwatchRef:A,overrideHex:z,onOverrideHexChange:d,overrideIsValid:S,overrideColorValue:F,onApplyOverride:N,palettePage:oe,palettePageCount:ue,onPalettePageChange:K,cellEditMode:fe,onToggleCellEditMode:V,cellEditColor:J,onCellEditColorChange:ae,cellEditTool:L,onCellEditToolChange:B})=>{const we=!C&&!W||C&&M.length===0;return e.jsxs(G,{sx:{...sn,width:400,minHeight:0,flexShrink:0},children:[e.jsx(G,{sx:{display:"flex",flexDirection:"column"},children:e.jsx(G,{sx:on,children:e.jsxs(te,{direction:"row",alignItems:"center",justifyContent:"space-between",spacing:1,sx:{flex:1},children:[e.jsx(U,{variant:"subtitle1",fontWeight:700,children:"색상 · 팔레트"}),e.jsx(Es,{size:"small",label:`${h.toLocaleString()} colors`,variant:"outlined"})]})})}),e.jsxs(G,{sx:{p:1.25,display:"flex",flexDirection:"column",gap:1.25},children:[e.jsxs(te,{direction:"row",spacing:1,alignItems:"center",flexWrap:"wrap",children:[e.jsx(Z,{size:"small",variant:fe?"contained":"outlined",onClick:V,children:"셀 편집"}),fe&&e.jsxs(e.Fragment,{children:[e.jsx(Z,{size:"small",variant:L==="brush"?"contained":"outlined",onClick:()=>B("brush"),children:"한칸"}),e.jsx(Z,{size:"small",variant:L==="area"?"contained":"outlined",onClick:()=>B("area"),children:"영역"}),e.jsx(G,{component:"input",type:"color",value:J,onChange:k=>ae(k.target.value),style:{width:36,height:36,border:"1px solid #ccc",borderRadius:4,padding:0}}),e.jsx(ke,{size:"small",label:"셀 색상",value:J,onChange:k=>ae(k.target.value),placeholder:"#RRGGBB",error:J.length>0&&!zn(J),sx:{width:110}})]})]}),e.jsx(It,{}),e.jsx(te,{direction:"row",spacing:1,alignItems:"center",flexWrap:"wrap",children:e.jsxs(ke,{select:!0,size:"small",label:"팔레트 정렬",value:f,onChange:k=>v(k.target.value),sx:{flex:1,minWidth:160},onFocus:()=>K(1),children:[e.jsx(ce,{value:"count",children:"비중 순"}),e.jsx(ce,{value:"light",children:"색상 계열 · 밝은 → 어두운"}),e.jsx(ce,{value:"dark",children:"색상 계열 · 어두운 → 밝은"})]})}),e.jsxs(te,{direction:"row",spacing:1,alignItems:"center",flexWrap:"wrap",children:[e.jsx(ke,{size:"small",label:"선택 색상",value:C?M.length===0?"":`${M.length}개 선택`:W??"",onChange:()=>{},disabled:!0,sx:{width:100}}),e.jsx(ke,{size:"small",label:"새 색상",value:z,onChange:k=>d(k.target.value),placeholder:"#RRGGBB",error:z.length>0&&!S,sx:{width:100},disabled:we}),e.jsx(G,{component:"input",type:"color",value:S?F:"#000000",onChange:k=>d(k.target.value),style:{width:34,height:34,border:"1px solid #ccc",borderRadius:4,padding:0},disabled:we}),e.jsx(Z,{variant:"contained",size:"small",onClick:N,disabled:!S||we,children:"적용"}),e.jsx(Z,{variant:C?"contained":"outlined",size:"small",onClick:P,children:"선택"})]})]}),e.jsxs(G,{sx:{minHeight:0,overflow:"auto"},children:[i.length===0&&e.jsxs(te,{sx:{p:1.25},spacing:1,alignItems:"center",children:[e.jsx(En,{color:"disabled"}),e.jsx(U,{variant:"body2",color:"text.secondary",children:"팔레트가 없습니다. 변환할 이미지를 불러오세요."})]}),i.map(k=>e.jsxs(G,{sx:{display:"flex",alignItems:"center",px:1.25,py:.75,borderBottom:"1px solid",borderColor:"divider",columnGap:1,cursor:"pointer",bgcolor:C&&M.includes(k.hex)||!C&&W===k.hex?"action.selected":"transparent"},ref:!C&&W===k.hex?re=>{A.current=re}:void 0,onClick:()=>{C?x(k.hex):m(k.hex)},children:[e.jsx(G,{sx:{width:32,height:32,borderRadius:.75,border:"1px solid",borderColor:"divider",bgcolor:k.hex,flexShrink:0}}),e.jsxs(G,{sx:{flex:1,display:"flex",alignItems:"center",justifyContent:"space-between",gap:1},children:[e.jsx(U,{variant:"body2",fontWeight:700,noWrap:!0,children:k.hex}),e.jsxs(U,{variant:"caption",color:"text.secondary",noWrap:!0,children:[k.count.toLocaleString()," px · ",k.percent,"%"]})]})]},k.hex))]}),ue>1&&e.jsx(G,{sx:{py:1,display:"flex",justifyContent:"center"},children:e.jsx(Is,{count:ue,page:oe,onChange:(k,re)=>K(re),color:"primary",size:"small",showFirstButton:!0,showLastButton:!0})})]})},eo=({open:i,pdfMode:h,onPdfModeChange:f,pdfLoading:v,onClose:C,onDownload:M})=>e.jsxs(zt,{open:i,onClose:C,maxWidth:"sm",fullWidth:!0,children:[e.jsx(Wt,{children:"PDF 다운로드"}),e.jsxs(Dt,{sx:{display:"flex",flexDirection:"column",gap:1.25,pt:1},children:[e.jsxs(te,{spacing:.5,children:[e.jsx(U,{variant:"subtitle2",children:"저장 모드"}),e.jsxs(zs,{row:!0,value:h,onChange:W=>f(W.target.value),children:[e.jsx(bt,{value:"original",control:e.jsx(Sn,{size:"small"}),label:"원본 크기(처리 크기)"}),e.jsx(bt,{value:"paper",control:e.jsx(Sn,{size:"small"}),label:"용지 맞춤"})]}),e.jsx(U,{variant:"caption",color:"text.secondary",children:"원본 크기: 처리된 이미지 크기(px) 그대로 저장 · 용지 맞춤: 선택한 용지에 맞춰 축소/배치"})]}),h==="paper"&&e.jsx(U,{variant:"caption",color:"text.secondary",children:"용지 맞춤은 기본 설정의 용지/방향 값을 사용합니다."}),e.jsx(U,{variant:"caption",color:"text.secondary",children:"현재 설정된 그리드 표시 상태를 그대로 적용해 PDF를 생성합니다."})]}),e.jsxs(Ht,{children:[e.jsx(Z,{onClick:C,disabled:v,children:"취소"}),e.jsx(Z,{onClick:M,variant:"outlined",color:"primary",disabled:v,children:v?"생성 중...":"다운로드"})]})]}),to=({imageSrc:i,pixelatedSrc:h,error:f,originalSize:v,renderedSize:C,uniqueCount:M,totalPixels:W,viewScale:P,onAdjustScale:x,showGrid:m,onToggleGrid:A,gridColor:z,onGridColorChange:d,gridLineColor:S,cellEditMode:F,cellEditPreview:N,onOpenEdit:oe,onOpenPdf:ue,onDropImage:K,onPreviewClick:fe,onPreviewMouseDown:V,onPreviewMouseUp:J,onPreviewTouch:ae,onPreviewMove:L,onPreviewLeave:B,scrollContainerRef:we,previewContainerRef:k,previewImgRef:re,magnifierCanvasRef:ne,previewHover:ve,magnifierSize:be,scaledWidth:se,scaledHeight:T,gridCols:he,gridRows:ie,gridCellWidth:xe,gridCellHeight:r})=>e.jsxs(G,{sx:{...sn,flex:1,minWidth:700,minHeight:0},children:[e.jsxs(G,{sx:on,children:[e.jsx(U,{variant:"subtitle1",fontWeight:700,children:"미리보기"}),e.jsxs(te,{direction:"row",spacing:1.5,alignItems:"center",flexWrap:"nowrap",justifyContent:"flex-end",children:[e.jsxs(te,{direction:"row",spacing:.5,alignItems:"center",children:[e.jsx(Z,{size:"small",variant:"outlined",onClick:()=>x(-10),disabled:!i,children:"-"}),e.jsxs(U,{variant:"body2",sx:{minWidth:48,textAlign:"center"},children:[P,"%"]}),e.jsx(Z,{size:"small",variant:"outlined",onClick:()=>x(10),disabled:!i,children:"+"})]}),e.jsx(It,{flexItem:!0,orientation:"vertical"}),e.jsx(bt,{control:e.jsx(Qt,{size:"small",checked:m,onChange:s=>A(s.target.checked)}),label:"그리드",disabled:!i}),m&&e.jsx(G,{component:"input",type:"color",value:z,onChange:s=>d(s.target.value),style:{width:32,height:32,border:"1px solid #ccc",borderRadius:4,padding:0},disabled:!i}),e.jsx(It,{flexItem:!0,orientation:"vertical"}),e.jsx(Z,{size:"small",variant:"outlined",startIcon:e.jsx(Ws,{}),onClick:oe,disabled:!i,children:"편집"}),e.jsx(Z,{size:"small",variant:"outlined",startIcon:e.jsx(Ds,{}),onClick:ue,disabled:!h,children:"PDF"})]})]}),e.jsxs(G,{sx:{p:1.25,display:"flex",flexDirection:"column",gap:1.25,flex:1,minHeight:0},onDragOver:s=>s.preventDefault(),onDrop:K,children:[e.jsxs(G,{sx:{flex:1,minWidth:0,width:"100%",maxWidth:"100%",border:"1px dashed",borderColor:i?"divider":"text.disabled",borderRadius:1,bgcolor:"background.default",position:"relative",overflow:"hidden",display:"flex",flexDirection:"column"},children:[!i&&e.jsxs(te,{sx:{inset:0,position:"absolute"},alignItems:"center",justifyContent:"center",spacing:1,children:[e.jsx(En,{color:"disabled"}),e.jsx(U,{variant:"body2",color:"text.secondary",children:"이미지를 업로드하세요."})]}),i&&e.jsx(G,{sx:{flex:1,position:"relative",minHeight:0,overflow:"hidden"},children:e.jsx(G,{ref:we,sx:{position:"absolute",inset:12,overflow:"auto",userSelect:"none"},onMouseDown:s=>{F&&(s.preventDefault(),V(s))},onMouseMove:s=>{s.target===s.currentTarget&&L(s)},onMouseUp:J,children:e.jsx(G,{sx:{width:se?`max(100%, ${se}px)`:"100%",height:T?`max(100%, ${T}px)`:"100%",minWidth:"100%",minHeight:"100%",display:"flex",alignItems:"center",justifyContent:"center"},children:h?e.jsxs(G,{ref:k,sx:{position:"relative",width:se??"auto",height:T??"auto",maxWidth:"none",maxHeight:"none",minWidth:se??void 0,minHeight:T??void 0,borderRadius:1,display:"inline-block"},children:[e.jsx(G,{component:"img",ref:re,src:h,alt:"변환 이미지",draggable:!1,onDragStart:s=>s.preventDefault(),onClick:fe,onMouseDown:s=>{s.preventDefault(),s.stopPropagation(),V(s)},onMouseUp:J,onTouchStart:ae,onMouseMove:L,onMouseLeave:B,sx:{width:"100%",height:"100%",maxWidth:"none",maxHeight:"none",imageRendering:"pixelated",display:"block",borderRadius:1,cursor:F?"cell":"crosshair",userSelect:"none",WebkitUserDrag:"none"}}),m&&se&&T&&he>0&&ie>0&&e.jsx(G,{sx:{pointerEvents:"none",position:"absolute",inset:0,borderRadius:1,backgroundImage:`linear-gradient(to right, ${S} 1px, transparent 1px),
                            linear-gradient(to bottom, ${S} 1px, transparent 1px)`,backgroundSize:`${xe??se/he}px ${r??T/ie}px`,backgroundPosition:"0 0"}}),F&&xe&&r&&Object.keys(N).length>0&&e.jsx(G,{component:"svg",sx:{pointerEvents:"none",position:"absolute",inset:0,width:"100%",height:"100%"},children:Object.entries(N).map(([s,u])=>{const[b,g]=s.split(",").map($=>Number($)),j=b*xe,X=g*r;return e.jsx("rect",{x:j,y:X,width:xe,height:r,fill:u,fillOpacity:.45},s)})}),e.jsxs(G,{sx:{pointerEvents:"none",position:"absolute",left:ve.x,top:ve.y,transform:"none",bgcolor:"background.paper",borderRadius:1,boxShadow:3,p:.5,display:ve.visible?"inline-flex":"none",flexDirection:"column",gap:.5,zIndex:2},children:[e.jsx("canvas",{ref:ne,width:be,height:be,style:{width:be,height:be}}),e.jsx(U,{variant:"caption",color:"text.secondary",sx:{textAlign:"center"},children:ve.color.toUpperCase()})]})]}):e.jsx(U,{variant:"body2",color:"text.secondary",children:"변환된 이미지를 준비하는 중입니다..."})})})})]}),i&&e.jsxs(te,{spacing:.25,direction:"row",justifyContent:"space-between",alignItems:"center",children:[e.jsxs(U,{variant:"caption",color:"text.secondary",children:["원본 크기: ",v.width," x ",v.height,"px",C.width!==v.width||C.height!==v.height?` · 처리 크기: ${C.width} x ${C.height}px`:""]}),e.jsxs(U,{variant:"caption",color:"text.secondary",children:["팔레트 색상: ",M.toLocaleString(),"개 · 픽셀: ",W.toLocaleString(),"개"]})]}),f&&e.jsx(Hs,{severity:"error",children:f})]})]}),no=({inputRef:i,onOpenLink:h,onTriggerUpload:f,onFileSelect:v,imageSrc:C,maxCols:M,blockSize:W,onBlockSizeChange:P,paletteSize:x,onPaletteSizeChange:m,stitchSizeMm:A,onStitchSizeChange:z,paperMarginMm:d,onPaperMarginChange:S,paperMode:F,onPaperModeChange:N,pdfOrientation:oe,onPdfOrientationChange:ue,customPaperWidthInput:K,customPaperHeightInput:fe,onCustomWidthChange:V,onCustomHeightChange:J,lockCustomPaperAspect:ae,onLockCustomPaperAspectChange:L,onApplyPaperFit:B,paperWidthMm:we,paperHeightMm:k,usableWidthMm:re,usableHeightMm:ne,estimatedCols:ve,estimatedRows:be,gridCols:se,gridRows:T,finalWidthMm:he,finalHeightMm:ie,useOriginalSize:xe,onUseOriginalSizeChange:r})=>e.jsxs(G,{sx:{...sn,width:320,flexShrink:0,minHeight:0},children:[e.jsxs(G,{sx:on,children:[e.jsx(U,{variant:"subtitle1",fontWeight:700,children:"이미지 업로드"}),e.jsx(Z,{size:"small",variant:"outlined",onClick:h,startIcon:e.jsx(Os,{}),children:"링크"})]}),e.jsxs(G,{sx:{p:1.25,display:"flex",flexDirection:"column",gap:1.25,flex:1,minHeight:0},children:[e.jsxs(te,{spacing:1,children:[e.jsx(Z,{fullWidth:!0,variant:"contained",startIcon:e.jsx(Fs,{}),onClick:f,children:"이미지 선택"}),e.jsx(U,{variant:"caption",color:"text.secondary",textAlign:"center",children:"업로드 또는 드래그&드롭"}),e.jsx("input",{type:"file",accept:"image/*",hidden:!0,ref:i,onChange:s=>{const u=s.target.files?.[0];u&&v(u)}})]}),e.jsx(It,{}),e.jsxs(te,{spacing:1,children:[e.jsx(U,{variant:"subtitle2",fontWeight:700,children:"기본 설정"}),e.jsxs(te,{spacing:.75,children:[e.jsx(U,{variant:"caption",color:"text.secondary",children:"가로 도트 개수"}),e.jsxs(te,{direction:"row",spacing:1,alignItems:"center",children:[e.jsx(Ls,{size:"small",min:1,max:M,step:1,value:W,onChange:(s,u)=>{typeof u=="number"&&P(u)},valueLabelDisplay:"auto",sx:{flex:1},disabled:!C}),e.jsx(ke,{size:"small",type:"number",inputProps:{min:1,max:M},value:W,onChange:s=>P(Number(s.target.value)),sx:{width:90},disabled:!C})]})]}),e.jsxs(ke,{select:!0,size:"small",label:"색상 수 제한",value:x,onChange:s=>m(Number(s.target.value)),sx:{minWidth:0},disabled:!C,children:[e.jsx(ce,{value:0,children:"제한 없음 (원본 색)"}),e.jsx(ce,{value:64,children:"64색"}),e.jsx(ce,{value:128,children:"128색"}),e.jsx(ce,{value:256,children:"256색"}),e.jsx(ce,{value:512,children:"512색"}),e.jsx(ce,{value:1024,children:"1024색"}),e.jsx(ce,{value:2048,children:"2048색"}),e.jsx(ce,{value:4096,children:"4096색"}),e.jsx(ce,{value:8192,children:"8192색"}),e.jsx(ce,{value:16384,children:"16384색"}),e.jsx(ce,{value:32768,children:"32768색"}),e.jsx(ce,{value:65536,children:"65536색"})]}),e.jsxs(te,{spacing:1,children:[e.jsx(U,{variant:"subtitle2",children:"칸 크기 · 용지 맞춤"}),e.jsxs(te,{direction:{xs:"column",sm:"row"},spacing:1,children:[e.jsx(ke,{size:"small",label:"1칸 크기 (mm)",type:"number",inputProps:{min:.1,step:.1},value:A,onChange:s=>z(Math.max(.1,Number(s.target.value)))}),e.jsx(ke,{size:"small",label:"여백 (mm)",type:"number",inputProps:{min:0,step:1},value:d,onChange:s=>S(Math.max(0,Number(s.target.value)))})]}),e.jsxs(te,{direction:{xs:"column",sm:"row"},spacing:1,children:[e.jsxs(ke,{select:!0,size:"small",label:"용지 모드",value:F,onChange:s=>N(s.target.value),sx:{minWidth:0},children:[e.jsx(ce,{value:"a5",children:"프리셋 · A5"}),e.jsx(ce,{value:"a4",children:"프리셋 · A4"}),e.jsx(ce,{value:"a3",children:"프리셋 · A3"}),e.jsx(ce,{value:"custom",children:"사용자 정의"})]}),e.jsxs(ke,{select:!0,size:"small",label:"방향",value:oe,onChange:s=>ue(s.target.value),sx:{minWidth:0},children:[e.jsx(ce,{value:"p",children:"세로"}),e.jsx(ce,{value:"l",children:"가로"})]})]}),F==="custom"&&e.jsxs(te,{direction:{xs:"column",sm:"row"},spacing:1,children:[e.jsx(ke,{size:"small",label:"가로 (mm)",value:K,onChange:s=>V(s.target.value),inputProps:{inputMode:"decimal",pattern:"[0-9.]*"}}),e.jsx(ke,{size:"small",label:"세로 (mm)",value:fe,onChange:s=>J(s.target.value),inputProps:{inputMode:"decimal",pattern:"[0-9.]*"}})]}),F==="custom"&&e.jsx(bt,{control:e.jsx(Qt,{size:"small",checked:ae,onChange:s=>L(s.target.checked)}),label:"이미지 비율로 커스텀 용지 비율 고정"}),e.jsx(Z,{variant:"outlined",size:"small",onClick:B,disabled:!C,children:"용지에 맞춰 칸 수 자동 계산"}),e.jsxs(te,{spacing:.5,children:[e.jsxs(U,{variant:"caption",color:"text.secondary",children:["선택한 용지: ",we.toFixed(0)," × ",k.toFixed(0)," mm"]}),e.jsxs(U,{variant:"caption",color:"text.secondary",children:["사용 가능 영역: ",re.toFixed(1)," × ",ne.toFixed(1)," mm"]}),e.jsxs(U,{variant:"caption",color:"text.secondary",children:["1칸 ",A.toFixed(2)," mm 기준"]}),e.jsxs(U,{variant:"caption",color:"text.secondary",children:["예상: ",ve," × ",be,"칸"]}),e.jsxs(U,{variant:"caption",color:"text.secondary",children:["현재 설정: ",se," × ",T,"칸"]}),e.jsxs(U,{variant:"caption",color:"text.secondary",children:["완성 약 ",(he/10).toFixed(1)," × ",(ie/10).toFixed(1)," cm"]})]})]}),e.jsx(bt,{control:e.jsx(Qt,{size:"small",checked:xe,onChange:s=>r(s.target.checked)}),label:"원본 크기로 처리",disabled:!C})]})]})]}),ho=()=>{const{imageSrc:i,pixelatedSrc:h,colors:f,uniqueCount:v,totalPixels:C,loading:M,error:W,originalSize:P,renderedSize:x,blockSize:m,setBlockSize:A,useOriginalSize:z,setUseOriginalSize:d,colorOverrides:S,applyColorOverride:F,applyCellOverridesBatch:N,undoCellEdit:oe,canUndoCellEdit:ue,applyColorOverridesBatch:K,paletteSize:fe,setPaletteSize:V,handleDataUrl:J,originalDataUrl:ae,renderedCols:L,renderedRows:B,progress:we}=_s(),k=n.useRef(null),re=n.useRef(null),ne=n.useRef(null),ve=n.useRef(null),be=n.useRef(null),se=n.useRef(null),T=n.useRef(null),he=n.useRef(null),ie=n.useRef(!1),[xe,r]=n.useState(!1),[s,u]=n.useState(""),[b,g]=n.useState(!1),[j,X]=n.useState(null),[$,p]=n.useState(!1),[R,E]=n.useState(!1),[Y,H]=n.useState("#000000"),[Me,De]=n.useState(100),[Ye,He]=n.useState(!1),[ze,Ct]=n.useState("original"),[Ke,st]=n.useState("p"),[D,I]=n.useState("a5"),[Q,ee]=n.useState(!1),[de,Re]=n.useState(null),[ge,me]=n.useState(null),[Pe,$e]=n.useState(""),[Ce,Ot]=n.useState(!1),[ot,Oe]=n.useState([]),[Ge,Ft]=n.useState("count"),[Ne,at]=n.useState(1),[pe,Lt]=n.useState(!1),[rt,Wn]=n.useState("#ff5252"),[We,Dn]=n.useState("brush"),[Hn,jt]=n.useState({}),[an,xt]=n.useState(!1),Fe=n.useRef(!1),gt=n.useRef(null),mt=n.useRef({}),Ve=n.useRef(null),On=()=>{Lt(t=>{const a=!t;return a||(Fe.current=!1,xt(!1),mt.current={},gt.current=null,Ve.current=null,jt({})),a})},[pt,Fn]=n.useState(1),[Ze,Ln]=n.useState(20),[Se,Bn]=n.useState("a5"),[yt,rn]=n.useState("210"),[ln,Bt]=n.useState("297"),[wt,An]=n.useState(!0),[Tn,St]=n.useState({visible:!1,x:0,y:0,color:"#000000"}),it=100,Je=16,je=Je*4,Xn=Math.max(1,Math.round((z?P.width:x.width)||512)),cn=x.width?x.height/x.width:P.width?P.height/P.width:1,Qe=L||Math.max(1,m),kt=B||Math.max(1,Math.round(Qe*cn)),At=Me/100,hn=x.width&&Qe?x.width/Qe:void 0,lt=hn?Math.max(1,Math.round(hn*At)):void 0,Tt=x.width?lt?Qe*lt:Math.round(x.width*At):void 0,Xt=x.height?lt?kt*lt:Math.round(x.height*At):void 0,Un=lt,Yn=lt,dn=n.useRef({scrollWidth:0,scrollHeight:0,left:0,top:0}),Ut=n.useRef(!0);n.useEffect(()=>{De(100),Ut.current=!0},[i]),n.useEffect(()=>{const t=be.current;t&&(!Tt||!Xt||requestAnimationFrame(()=>{const a=dn.current,o=Ut.current?.5:a.scrollWidth>0?(a.left+t.clientWidth/2)/a.scrollWidth:.5,l=Ut.current?.5:a.scrollHeight>0?(a.top+t.clientHeight/2)/a.scrollHeight:.5,c=o*t.scrollWidth,w=l*t.scrollHeight,y=Math.max(0,t.scrollWidth-t.clientWidth),O=Math.max(0,t.scrollHeight-t.clientHeight);t.scrollLeft=Math.min(Math.max(c-t.clientWidth/2,0),y),t.scrollTop=Math.min(Math.max(w-t.clientHeight/2,0),O),dn.current={scrollWidth:t.scrollWidth,scrollHeight:t.scrollHeight,left:t.scrollLeft,top:t.scrollTop}}))},[i,Xt,Tt,Me]),n.useEffect(()=>{if(!i||(he.current!==i&&(ie.current=!1,he.current=i),ie.current))return;const t=x.width||P.width,a=x.height||P.height;!t||!a||st(t>=a?"l":"p")},[i,P.height,P.width,x.height,x.width]);const $n=t=>{ie.current=!0,st(t)},ct=n.useMemo(()=>{const t=[...f];if(Ge==="light"||Ge==="dark"){const a=o=>{const l=parseInt(o.slice(1,3),16)/255,c=parseInt(o.slice(3,5),16)/255,w=parseInt(o.slice(5,7),16)/255,y=Math.max(l,c,w),O=Math.min(l,c,w),q=y-O;let _=0;q!==0&&(y===l?_=(c-w)/q%6:y===c?_=(w-l)/q+2:_=(l-c)/q+4,_=Math.round(_*60),_<0&&(_+=360));const le=(y+O)/2,ye=q===0?0:q/(1-Math.abs(2*le-1));return{h:_,s:ye,l:le}};t.sort((o,l)=>{const c=a(o.hex),w=a(l.hex),y=c.s<.08,O=w.s<.08;return y&&O?Ge==="light"?w.l-c.l:c.l-w.l:y!==O?y?-1:1:c.h!==w.h?c.h-w.h:c.s!==w.s?w.s-c.s:Ge==="light"?w.l-c.l:c.l-w.l})}return t},[f,Ge]),Yt=Math.max(1,Math.ceil(ct.length/it)),Gn=n.useMemo(()=>ct.slice((Ne-1)*it,Ne*it),[Ne,it,ct]);n.useEffect(()=>{at(t=>Math.min(t,Yt))},[Yt]);const Nn=()=>k.current?.click(),qn=t=>{De(a=>Math.min(300,Math.max(50,Math.round(a+t))))},$t=t=>new Promise((a,o)=>{const l=new FileReader;l.onload=()=>a(String(l.result)),l.onerror=c=>o(c),l.readAsDataURL(t)}),_n=async t=>{const a=await fetch(t);if(!a.ok)throw new Error("이미지를 불러오지 못했습니다.");const o=await a.blob();return $t(new File([o],"remote-image"))},vt=t=>{X(t),g(!0)},Kn=()=>{const t=ae??i;if(t){if(ae&&h){p(!0);return}vt(t)}},Vn=n.useCallback(t=>{t.preventDefault();const a=t.dataTransfer?.files?.[0];a&&$t(a).then(vt).catch(()=>{})},[]),Zn=async()=>{const t=s.trim();if(t)try{const a=await _n(t);vt(a),u(""),r(!1)}catch{u(""),r(!1)}},Jn=async t=>{try{const a=await $t(t);vt(a)}catch{return}},Qn=t=>{J(t),g(!1),X(null)},es=()=>{j&&J(j),g(!1),X(null)},ts=()=>{g(!1),X(null)},ns=t=>{const a=t==="preview"?h:ae??i;a&&(p(!1),vt(a))},ht=n.useCallback(t=>new Promise((a,o)=>{const l=new Image;l.crossOrigin="anonymous",l.onload=()=>a(l),l.onerror=c=>o(c),l.src=t}),[]),ss=n.useCallback(async t=>{if(t.startsWith("data:image/png"))return t;const a=await ht(t),o=document.createElement("canvas");o.width=a.width,o.height=a.height;const l=o.getContext("2d");return l?(l.drawImage(a,0,0),o.toDataURL("image/png")):t},[ht]),Gt=/^#[0-9a-fA-F]{6}$/.test(Y)?Y:"#000000";n.useEffect(()=>{let t=!1;return(async()=>{if(!h){const o=re.current;o&&(o.width=0,o.height=0);return}try{const o=await ht(h);if(t)return;const l=re.current;if(!l)return;l.width=o.width,l.height=o.height;const c=l.getContext("2d");if(!c)return;c.imageSmoothingEnabled=!1,c.clearRect(0,0,l.width,l.height),c.drawImage(o,0,0,o.width,o.height)}catch{const o=re.current;o&&(o.width=0,o.height=0)}})(),()=>{t=!0}},[ht,h]);const os=n.useCallback(async()=>{if(!h||!x.width||!x.height)return null;const t=await ht(h),a=document.createElement("canvas");a.width=t.width,a.height=t.height;const o=a.getContext("2d");return o?(o.imageSmoothingEnabled=!1,o.drawImage(t,0,0,t.width,t.height),R&&(c=>{const w=L||m||1,y=B||Math.max(1,Math.round(t.height/t.width*w)),O=t.width/w,q=t.height/y;o.strokeStyle=c,o.lineWidth=1;for(let _=0;_<=w;_++){const le=Math.round(_*O);o.beginPath(),o.moveTo(le+.5,0),o.lineTo(le+.5,t.height),o.stroke()}for(let _=0;_<=y;_++){const le=Math.round(_*q);o.beginPath(),o.moveTo(0,le+.5),o.lineTo(t.width,le+.5),o.stroke()}})(Gt),a.toDataURL("image/png")):null},[m,Gt,ht,h,L,B,x.height,x.width,R]),un=t=>{const a=ct;if(a.length===0)return;const o=t.internal.pageSize.getWidth(),l=t.internal.pageSize.getHeight(),c=Math.max(8,Math.min(16,o*.06)),w=Math.max(8,Math.min(16,l*.06)),y=Math.max(6,Math.min(12,Math.round(o*.04))),O=y+4,q=14,_=y+40,le=Math.max(1,Math.floor((o-c*2+q)/(_+q))),ye=(o-c*2-q*(le-1))/le,Xe=Math.max(1,Math.floor((l-w*2)/O))*le;t.addPage(),t.setFontSize(10);let Ee=0;a.forEach(et=>{Ee>=Xe&&(t.addPage(),Ee=0);const ut=Math.floor(Ee/le),ft=Ee%le,tt=c+ft*(ye+q),nt=w+ut*O+y;t.setFillColor(et.hex),t.setDrawColor(0),t.rect(tt,nt-y+2,y,y,"F"),t.text(`${et.hex}`,tt+y+4,nt+2),Ee+=1})},as=Math.max(10,Pn(yt,210)),rs=Math.max(10,Pn(ln,297)),is={a5:{width:148,height:210},a4:{width:210,height:297},a3:{width:297,height:420}}[D],fn=Se==="custom"?{width:as,height:rs}:is,Rt=Math.max(10,fn.width),Pt=Math.max(10,fn.height),xn=Ke==="p"?Rt:Pt,gn=Ke==="p"?Pt:Rt,mn=Math.max(10,xn-Ze*2),pn=Math.max(10,gn-Ze*2),dt=cn||1,wn=Math.max(1,Math.floor(mn/Math.max(.1,pt))),ls=Math.max(1,Math.floor(pn/Math.max(.1,pt*dt))),Nt=Math.max(1,Math.min(wn,ls||wn)),cs=Math.max(1,Math.round(Nt*dt)),hs=Qe*pt,ds=kt*pt,us=()=>{i&&A(Nt)},fs=t=>{const a=t.replace(/[^\d.]/g,"");if(rn(a),Se==="custom"&&wt){const o=parseFloat(a);if(!Number.isNaN(o)&&o>0){const l=Math.max(10,Number((o*dt).toFixed(2)));Bt(l.toFixed(2))}}},xs=t=>{const a=t.replace(/[^\d.]/g,"");if(Bt(a),Se==="custom"&&wt){const o=parseFloat(a);if(!Number.isNaN(o)&&o>0){const l=Math.max(10,Number((o/dt).toFixed(2)));rn(l.toFixed(2))}}};n.useEffect(()=>{if(Se==="custom"&&wt){const t=parseFloat(yt);if(!Number.isNaN(t)&&t>0){const a=Math.max(10,Number((t*dt).toFixed(2)));Bt(a.toFixed(2))}}},[dt,yt,wt,Se]),n.useEffect(()=>{(Se==="a5"||Se==="a4"||Se==="a3")&&I(Se)},[Se]);const gs=async()=>{if(i&&!(!h||!x.width||!x.height)){Re(null),ee(!0);try{const t=await ss(i),a=await os();if(!a)throw new Error("PDF로 변환할 이미지를 준비하지 못했습니다.");if(ze==="original"){const o=x.width>=x.height?"l":"p",l=Math.max(x.width,P.width),c=Math.max(x.height,P.height),w=new yn({orientation:o,unit:"px",format:[l,c]});w.addImage(t,"PNG",0,0,P.width,P.height),w.addPage([x.width,x.height]),w.addImage(a,"PNG",0,0,x.width,x.height),un(w),w.save("cross-stitch.pdf")}else{const o=ks=>ks*.264583,l=new yn({orientation:Ke,unit:"mm",format:Se==="custom"?[Rt,Pt]:D}),c=l.internal.pageSize.getWidth(),w=l.internal.pageSize.getHeight(),y=l.getImageProperties(t),O=o(y.width),q=o(y.height),_=Math.max(1,c-Ze*2),le=Math.max(1,w-Ze*2),ye=Math.min(_/O,le/q),Te=O*ye,Xe=q*ye,Ee=(c-Te)/2,et=(w-Xe)/2;l.addImage(t,"PNG",Ee,et,Te,Xe),l.addPage(Se==="custom"?[Rt,Pt]:D);const ut=l.internal.pageSize.getWidth(),ft=l.internal.pageSize.getHeight(),tt=l.getImageProperties(a),nt=o(tt.width),Et=o(tt.height),Vt=Math.max(1,ut-Ze*2),Ue=Math.max(1,ft-Ze*2),bn=Math.min(Vt/nt,Ue/Et),Cn=nt*bn,jn=Et*bn,ys=(ut-Cn)/2,Ss=(ft-jn)/2;l.addImage(a,"PNG",ys,Ss,Cn,jn),un(l),l.save("cross-stitch.pdf")}He(!1)}catch(t){console.error(t),Re("PDF 생성에 실패했습니다. 잠시 후 다시 시도해주세요.")}finally{ee(!1)}}};n.useEffect(()=>{if(f.length===0){me(null),$e(""),Oe([]);return}at(1),me(t=>t&&f.some(o=>o.hex===t)?t:f[0].hex),Oe(t=>t.filter(a=>f.some(o=>o.hex===a)))},[f]),n.useEffect(()=>{if(!ge)return;const t=S[ge];$e(t??ge)},[ge,S]);const qt=zn(Pe),ms=qt?Pe.startsWith("#")?Pe:`#${Pe}`:"#000000",vn=n.useCallback(t=>{const a=Js(t);if(!a)return;const o=ct.findIndex(c=>c.hex===a);if(o===-1)return;const l=Math.floor(o/it)+1;at(l),Ce?Oe(c=>c.includes(a)?c:[...c,a]):(me(a),$e(S[a]??a))},[S,Ce,it,ct]),Le=n.useCallback((t,a,o)=>{if(!h)return null;const l=ne.current,c=re.current;if(!l||!c||c.width===0||c.height===0)return null;const w=l.getBoundingClientRect();if(w.width===0||w.height===0)return null;let y=(t-w.left)/w.width,O=(a-w.top)/w.height;if(o?.clamp)y=Math.min(1,Math.max(0,y)),O=Math.min(1,Math.max(0,O));else if(y<0||y>1||O<0||O>1)return null;const q=Math.min(c.width-1,Math.max(0,Math.floor(y*c.width))),_=Math.min(c.height-1,Math.max(0,Math.floor(O*c.height))),le=c.getContext("2d");if(!le)return null;const ye=le.getImageData(q,_,1,1).data;if(ye[3]===0)return null;const Te=Ee=>Ee.toString(16).padStart(2,"0"),Xe=`#${Te(ye[0])}${Te(ye[1])}${Te(ye[2])}`;return(o?.focusPalette??!0)&&(Oe([]),vn(Xe)),{hex:Xe,canvasX:q,canvasY:_}},[vn,h]),Be=n.useCallback((t,a)=>{if(!L||!B)return null;const o=re.current;if(!o||o.width===0||o.height===0)return null;const l=o.width/L,c=o.height/B,w=Math.min(L-1,Math.max(0,Math.floor(t/l))),y=Math.min(B-1,Math.max(0,Math.floor(a/c)));return{col:w,row:y}},[L,B]),Ae=n.useCallback((t,a)=>{const o=`${t},${a}`;gt.current!==o&&(gt.current=o,mt.current[o]=rt,jt(l=>({...l,[o]:rt})))},[rt]),qe=n.useCallback((t,a)=>{const o=Math.max(0,Math.min(t.col,a.col)),l=Math.max(t.col,a.col),c=Math.max(0,Math.min(t.row,a.row)),w=Math.max(t.row,a.row),y={};for(let O=c;O<=w;O+=1)for(let q=o;q<=l;q+=1)y[`${q},${O}`]=rt;mt.current=y,jt(y)},[rt]),_e=n.useCallback(async()=>{const t=Object.entries(mt.current).map(([a,o])=>{const[l,c]=a.split(",").map(w=>Number(w));return{col:l,row:c,color:o}});mt.current={},gt.current=null,Ve.current=null,jt({}),t.length>0&&await N(t)},[N]),Mn=n.useCallback((t,a)=>{const o=re.current,l=se.current;if(!o||!l)return;const c=l.getContext("2d");if(!c)return;const w=Math.floor(Je/2),y=Math.max(0,Math.min(o.width-Je,t-w)),O=Math.max(0,Math.min(o.height-Je,a-w));c.imageSmoothingEnabled=!1,c.clearRect(0,0,je,je),c.drawImage(o,y,O,Je,Je,0,0,je,je),c.strokeStyle="rgba(0,0,0,0.35)",c.lineWidth=1,c.strokeRect(.5,.5,je-1,je-1),c.beginPath(),c.moveTo(je/2,0),c.lineTo(je/2,je),c.moveTo(0,je/2),c.lineTo(je,je/2),c.stroke()},[je,Je]),ps=n.useCallback(t=>{const a=Le(t.clientX,t.clientY,{focusPalette:!pe});if(a&&pe){if(We==="area")return;const o=Be(a.canvasX,a.canvasY);o&&(Ae(o.col,o.row),_e());return}},[pe,We,_e,Be,Le,Ae]),ws=n.useCallback(t=>{if(!pe)return;Fe.current=!0,xt(!0);const a=Le(t.clientX,t.clientY,{focusPalette:!1,clamp:!0});if(!a){Fe.current=!1,xt(!1);return}const o=Be(a.canvasX,a.canvasY);if(o){if(We==="area"){Ve.current=o,gt.current=null,qe(o,o);return}Ae(o.col,o.row)}},[qe,pe,We,Be,Le,Ae]),vs=n.useCallback(()=>{Fe.current&&(Fe.current=!1,xt(!1),_e())},[_e]),Ms=n.useCallback(t=>{const a=t.touches[0];if(!a)return;const o=Le(a.clientX,a.clientY,{focusPalette:!pe});if(o&&pe){const l=Be(o.canvasX,o.canvasY);l&&(We==="area"?qe(l,l):Ae(l.col,l.row),_e())}St({visible:!1,x:0,y:0,color:"#000000"})},[qe,pe,We,_e,Be,Le,Ae]),bs=n.useCallback(t=>{const a=Le(t.clientX,t.clientY,{focusPalette:!1,clamp:pe&&Fe.current}),o=ve.current,l=ne.current;if(!a||!o){St(Ue=>Ue.visible?{...Ue,visible:!1}:Ue);return}if(pe&&Fe.current){const Ue=Be(a.canvasX,a.canvasY);Ue&&(We==="area"&&Ve.current?qe(Ve.current,Ue):Ae(Ue.col,Ue.row))}if(!l)return;Mn(a.canvasX,a.canvasY);const c=o.getBoundingClientRect(),w=l.getBoundingClientRect(),y=12,O=je,q=t.clientX-c.left,_=t.clientY-c.top,le=w.left-c.left,ye=w.top-c.top,Te=le+w.width,Xe=ye+w.height,Ee=le,et=ye,ut=Math.max(Ee,Te-O),ft=Math.max(et,Xe-O),tt=q+y+O>Te?q-y-O:q+y,nt=_+y+O>Xe?_-y-O:_+y,Et=Math.min(Math.max(tt,Ee),ut),Vt=Math.min(Math.max(nt,et),ft);St({visible:!0,x:Et,y:Vt,color:a.hex})},[qe,pe,We,Mn,Be,Le,Ae]),Cs=n.useCallback(()=>{St(t=>t.visible?{...t,visible:!1}:t)},[]),_t=n.useCallback(t=>{if(!Fe.current)return;const a=Le(t.clientX,t.clientY,{focusPalette:!1,clamp:!0});if(a&&pe){const o=Be(a.canvasX,a.canvasY);o&&(We==="area"&&Ve.current?qe(Ve.current,o):Ae(o.col,o.row))}},[qe,pe,We,Be,Le,Ae]),Kt=n.useCallback(()=>{Fe.current&&(Fe.current=!1,xt(!1),_e())},[_e]);n.useEffect(()=>{if(an)return window.addEventListener("mousemove",_t),window.addEventListener("mouseup",Kt),()=>{window.removeEventListener("mousemove",_t),window.removeEventListener("mouseup",Kt)}},[_t,Kt,an]),n.useEffect(()=>{const t=a=>{if(!((a.metaKey||a.ctrlKey)&&a.key.toLowerCase()==="z"))return;const l=a.target,c=l?.tagName?.toLowerCase();c==="input"||c==="textarea"||l?.isContentEditable||ue&&(a.preventDefault(),oe())};return window.addEventListener("keydown",t),()=>window.removeEventListener("keydown",t)},[ue,oe]);const js=async()=>{if(!qt)return;const t=Pe.startsWith("#")?Pe:`#${Pe}`;if(Ce){if(ot.length===0)return;await K(ot,t)}else{if(!ge)return;await F(ge,t)}$e(t)};return e.jsxs(e.Fragment,{children:[e.jsxs(Bs,{sx:{p:1.25,display:"flex",flexDirection:"column",gap:1.25,flex:1,minHeight:785,height:"100%",width:1,maxWidth:"100%",overflowX:"hidden"},children:[e.jsxs(te,{direction:"row",spacing:1.25,sx:{width:"100%",maxWidth:"100%",minHeight:770,height:"calc(100vh - 190px)"},children:[e.jsx(no,{inputRef:k,onOpenLink:()=>r(!0),onTriggerUpload:Nn,onFileSelect:t=>void Jn(t),imageSrc:i,maxCols:Xn,blockSize:m,onBlockSizeChange:A,paletteSize:fe,onPaletteSizeChange:V,stitchSizeMm:pt,onStitchSizeChange:Fn,paperMarginMm:Ze,onPaperMarginChange:Ln,paperMode:Se,onPaperModeChange:Bn,pdfOrientation:Ke,onPdfOrientationChange:$n,customPaperWidthInput:yt,customPaperHeightInput:ln,onCustomWidthChange:fs,onCustomHeightChange:xs,lockCustomPaperAspect:wt,onLockCustomPaperAspectChange:An,onApplyPaperFit:us,paperWidthMm:xn,paperHeightMm:gn,usableWidthMm:mn,usableHeightMm:pn,estimatedCols:Nt,estimatedRows:cs,gridCols:Qe,gridRows:kt,finalWidthMm:hs,finalHeightMm:ds,useOriginalSize:z,onUseOriginalSizeChange:d}),e.jsx(to,{imageSrc:i,pixelatedSrc:h,error:de??W,originalSize:P,renderedSize:x,uniqueCount:v,totalPixels:C,viewScale:Me,onAdjustScale:qn,showGrid:R,onToggleGrid:E,gridColor:Y,onGridColorChange:H,gridLineColor:Gt,cellEditMode:pe,cellEditPreview:Hn,onOpenEdit:Kn,gridCellWidth:Un,gridCellHeight:Yn,onOpenPdf:()=>He(!0),onDropImage:Vn,onPreviewClick:ps,onPreviewMouseDown:ws,onPreviewMouseUp:vs,onPreviewTouch:Ms,onPreviewMove:bs,onPreviewLeave:Cs,scrollContainerRef:be,previewContainerRef:ve,previewImgRef:ne,magnifierCanvasRef:se,previewHover:Tn,magnifierSize:je,scaledWidth:Tt,scaledHeight:Xt,gridCols:Qe,gridRows:kt}),e.jsx(Qs,{palette:Gn,uniqueCount:v,paletteSort:Ge,onSortChange:Ft,multiSelectMode:Ce,multiSelection:ot,selectedPalette:ge,onToggleSelectMode:()=>{Ot(t=>!t),Oe([])},onToggleSelection:t=>Oe(a=>a.includes(t)?a.filter(o=>o!==t):[...a,t]),onSelectPalette:t=>{me(t),$e(S[t]??t)},selectedSwatchRef:T,overrideHex:Pe,onOverrideHexChange:$e,overrideIsValid:qt,overrideColorValue:ms,onApplyOverride:js,palettePage:Ne,palettePageCount:Yt,onPalettePageChange:at,cellEditMode:pe,onToggleCellEditMode:On,cellEditColor:rt,onCellEditColorChange:Wn,cellEditTool:We,onCellEditToolChange:Dn})]}),e.jsx(Vs,{open:xe,linkValue:s,onClose:()=>r(!1),onChange:u,onSubmit:Zn}),e.jsx(Ks,{open:$,onClose:()=>p(!1),onSelect:ns}),e.jsx(Zs,{open:b,dataUrl:j,onApply:Qn,onSkip:es,onCancel:ts}),e.jsx(eo,{open:Ye,pdfMode:ze,onPdfModeChange:Ct,pdfLoading:Q,onClose:()=>He(!1),onDownload:gs})]}),e.jsx("canvas",{ref:re,style:{display:"none"}}),e.jsx(As,{open:M,sx:{color:"#fff",zIndex:t=>t.zIndex.tooltip+1},children:e.jsxs(te,{alignItems:"center",spacing:1,children:[e.jsx(Ts,{color:"inherit"}),e.jsx(U,{variant:"body2",children:"이미지를 처리하는 중입니다…"}),e.jsxs(U,{variant:"caption",children:[we.toFixed(0),"%"]})]})})]})};export{ho as default};
